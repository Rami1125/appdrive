<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×•×¤×¡ ×ª×™×¢×•×“ ×¢×‘×•×“×” - ×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chosen Palette: Bright Blue, White, and Light Blue Background -->
    <!-- Application Structure Plan: The application is designed as a multi-step wizard (3 pages) to guide the driver through the documentation process logically. This structure mimics the natural workflow of a delivery: 1. Confirm Order, 2. Log Field Events, 3. Get Client Approval. This sequential flow minimizes cognitive load and ensures all necessary data is captured before submission. A progress bar provides clear visual feedback on completion status. The user flow is designed for mobile-first usability with large, touch-friendly controls. The first page now supports both selecting an existing order and initiating a new one, providing flexibility for different operational scenarios. -->
    <!-- Visualization & Content Choices: The application uses structured HTML forms styled with Tailwind CSS for a clean, modern interface. Interactive elements like dropdowns for driver/order selection, dynamic addition of return items, and a modal for transfer details streamline data entry. The "Start New Order" button dynamically reveals new input fields for manual order creation. For the client signature, a canvas element with the SignaturePad.js library provides a smooth signing experience. Finally, jsPDF and html2canvas are used to generate a professional PDF report on the client-side, mirroring a formal document. This approach avoids server-side dependencies for PDF generation, making the single-page application self-contained. The design now incorporates glassmorphism for a premium feel, enhanced button animations, and a responsive table with hover effects for better user interaction. Location tracking is added to capture driver's coordinates at the time of submission. A new driver guidance system provides real-time feedback and alerts. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f0f8ff; /* Very light blue background */ }
        .form-section {
            background: rgba(255, 255, 255, 0.4); /* More transparent white for glassmorphism */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2); /* Deeper shadow */
            backdrop-filter: blur(15px); /* Stronger glassmorphism blur */
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3); /* More defined white border */
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother entrance animation */
            transform: translateY(30px);
            opacity: 0;
        }
        .form-section.active-page {
            transform: translateY(0);
            opacity: 1;
        }
        .progress-step { transition: all 0.4s ease-in-out; }
        .progress-step-active { background-color: #007bff; color: white; transform: scale(1.1); } /* Slight scale for active step */
        .progress-step-inactive { background-color: #a7d9ed; /* Lighter blue for inactive */ }
        .progress-line { background-color: #a7d9ed; height: 5px; transition: all 0.4s ease-in-out; }
        
        /* Enhanced Primary Button */
        .btn-primary { 
            background: linear-gradient(145deg, #007bff, #004c99); /* Deeper blue gradient */
            color: white; 
            transition: all 0.3s ease-in-out; 
            transform: scale(1);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4); /* Stronger, bluer glow */
            border: none;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* Consistent rounded corners */
            font-weight: 700; /* Bolder text */
        }
        .btn-primary:hover { 
            background: linear-gradient(145deg, #004c99, #007bff); /* Reverse gradient on hover */ 
            transform: scale(1.03); /* Subtle scale */
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.5); /* Even stronger glow */
        }
        .btn-primary:active {
            transform: scale(0.97); /* Click animation */
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.2);
        }
        .btn-primary::after { /* Bubble effect */
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.6); /* Brighter bubble */
            opacity: 0;
            border-radius: 50%;
            transform: scale(1) translate(-50%, -50%);
            transition: all 0.6s ease-out; /* Slower, smoother bubble */
        }
        .btn-primary:active::after {
            transform: scale(150) translate(-50%, -50%); /* Larger bubble */
            opacity: 1;
        }

        /* Enhanced Secondary Button */
        .btn-secondary { 
            background-color: #8899a6; /* Slightly lighter gray */ 
            color: white; 
            transition: all 0.2s ease-in-out; 
            transform: scale(1);
            box-shadow: 0 4px 6px rgba(108, 117, 125, 0.2);
            border: none;
            border-radius: 0.75rem; /* Consistent rounded corners */
        }
        .btn-secondary:hover { 
            background-color: #6a7680; 
            transform: scale(1.03);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.3);
        }
        .btn-secondary:active {
            transform: scale(0.97);
        }

        /* Enhanced Choice Button */
        .btn-choice { 
            background-color: rgba(255, 255, 255, 0.6); 
            border: 1px solid rgba(0, 123, 255, 0.2); 
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* Consistent rounded corners */
        }
        .btn-choice:hover {
            background-color: rgba(255, 255, 255, 0.9); /* More opaque on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-choice-active { 
            background-color: #e0f0ff; 
            border-color: #007bff; 
            color: #0056b3; 
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5); /* Stronger glow */
        }

        .signature-pad-container {
            background: rgba(255, 255, 255, 0.6); 
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4); 
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.15), 0 6px 12px rgba(0, 0, 0, 0.25); /* Deeper inner and outer shadow */
            border-radius: 1rem; /* More rounded */
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); } /* Darker, more opaque backdrop */
        .modal-content {
            background: rgba(255, 255, 255, 0.95); /* Almost opaque white */
            border-radius: 1.25rem;
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.45); /* Stronger shadow */
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            transform: scale(0.9); /* Start smaller */
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother modal animation */
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }
        
        .responsive-table th, .responsive-table td {
            padding: 14px 28px; /* More padding */
            text-align: right;
            border-bottom: 1px solid #cce7f5; /* Slightly darker blue border */
        }
        .responsive-table th {
            background-color: #d1eaff; /* Brighter blue header */
            font-weight: 700;
            color: #004c99; /* Darker blue text */
        }
        .responsive-table tbody tr:hover {
            background-color: #eaf7fc; /* Even lighter blue on hover */
        }
        .responsive-table {
            border-radius: 1rem; /* More rounded table */
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); /* More prominent shadow */
        }

        /* Enhanced Driver Messages Section */
        .message-box {
            background: linear-gradient(135deg, rgba(224, 240, 255, 0.9), rgba(190, 225, 255, 0.8)); /* Gradient background */
            border-left: 8px solid #007bff; /* Thicker blue border */
            padding: 1.25rem;
            border-radius: 1rem; /* More rounded */
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2); /* Soft blue shadow */
            animation: fadeInScale 0.6s ease-out; /* New animation */
        }
        .message-box.error {
            background: linear-gradient(135deg, rgba(255, 230, 230, 0.9), rgba(255, 200, 200, 0.8)); /* Red gradient */
            border-left: 8px solid #dc3545; /* Thicker red border */
            box-shadow: 0 44px 15px rgba(220, 53, 69, 0.2);
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* WhatsApp Button */
        .whatsapp-btn {
            background: linear-gradient(145deg, #25D366, #128C7E); /* WhatsApp gradient */
            color: white;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(37, 211, 102, 0.3);
            border-radius: 0.75rem; /* Consistent rounded corners */
            font-weight: 600;
        }
        .whatsapp-btn:hover {
            background: linear-gradient(145deg, #128C7E, #25D366);
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }
        .whatsapp-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(37, 211, 102, 0.1);
        }

        /* Logo effect - enhanced */
        .logo-container {
            position: relative;
            display: inline-block;
            border-radius: 50%;
            padding: 8px; /* More padding for a larger glow */
            background: linear-gradient(45deg, #007bff, #00d4ff); /* Brighter gradient for the frame */
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); /* Stronger initial glow */
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Elegant animation */
            animation: pulseGlow 2s infinite alternate; /* Pulsing glow animation */
        }
        .logo-container:hover {
            box-shadow: 0 0 30px rgba(0, 123, 255, 0.8), 0 0 50px rgba(0, 123, 255, 0.3); /* Even stronger glow on hover */
            transform: scale(1.05); /* More pronounced scale */
            animation: none; /* Stop pulsing on hover */
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 20px rgba(0, 123, 255, 0.5); }
            100% { box-shadow: 0 0 30px rgba(0, 123, 255, 0.7), 0 0 40px rgba(0, 123, 255, 0.2); }
        }

        /* PDF specific styles for better rendering */
        /* IMPORTANT: These styles are applied to the temporary div that html2canvas renders */
        .pdf-header-info {
            font-size: 8px; /* Smaller font for contact details */
            text-align: left;
            color: #555;
            margin-top: 2px; /* Smaller margin */
            line-height: 1.2; /* Tighter line height */
        }
        .pdf-section-title {
            font-size: 14px; /* Smaller font for section titles */
            font-weight: bold;
            color: #004c99; /* Darker blue for titles */
            margin-top: 8px; /* Smaller margin */
            margin-bottom: 4px; /* Smaller margin */
            border-bottom: 1px solid #cce7f5;
            padding-bottom: 3px; /* Smaller padding */
        }
        .pdf-data-label {
            font-weight: bold;
            color: #333;
        }
        .pdf-data-value {
            color: #555;
            font-size: 10px; /* Smaller font for data values */
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px; /* Smaller margin */
            font-size: 9px; /* Smaller font for table content */
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #ddd;
            padding: 4px; /* Smaller padding */
            text-align: right;
        }
        .pdf-table th {
            background-color: #f0f8ff;
            color: #004c99;
        }
        .pdf-stamp-box {
            border: 1px solid #007bff; /* Thinner border */
            padding: 8px; /* Smaller padding */
            border-radius: 6px; /* Smaller radius */
            margin-top: 10px; /* Smaller margin */
            background-color: rgba(240, 248, 255, 0.5);
            font-size: 9px; /* Smaller font */
        }
        .pdf-stamp-box h4 {
            font-size: 12px; /* Smaller font for stamp title */
            margin-bottom: 5px; /* Smaller margin */
        }
        .pdf-signature-area {
            border-bottom: 1px solid #333;
            height: 30mm; /* Fixed height for signature - reduced */
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            max-width: 80mm; /* Max width for signature box - reduced */
        }
        .pdf-copyright {
            font-size: 8px; /* Smaller font */
            text-align: center;
            color: #888;
            margin-top: 15px; /* Smaller margin */
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app" class="container mx-auto max-w-2xl p-4 min-h-screen">
        <header class="text-center mb-6">
            <div class="logo-container mx-auto mb-4">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAABZVBMVEX///9clMcBaKr//v/8//////35///z//////v//fr//v0AaqpYlcv///k4dJ9clMQAYqdsm7eYsc3w//8AZahfiq0AarAAaqdYkL5ck8v/+/+fwM///fQAWJsAarF4pLmJrcF/pMMLYJd3pL+MtsuOr8kAXaY/dLAAWJbo//8AVpQAY6cAVo4AbKYAZ7IAX5210eAAXpdBeaC72uLb8vYAU6AAVpxblr7O4+gAWo8ATo6u0N8Aa7lklK8AVH4WXo2eydNKg6H/+ucAT4Rto7FykKxjiKxZk9KbtMSyythYhbJbiLynwchoj7dBjMQxfrQ2b5bf9Pw7c5UATntPdYsAR4lajKaCscUtZIxamrzN8vVWntCaydzE5ewAZLapwtYCcKOc1elwrMiVp7kAOH8/h8Q8fpbF5fVnhZ1vkZUmVnbc5Oa/1dmPqK0ATnwAQXtRqMyCvtG17flKaZMUbYoAOWV8kaYyyqEqAAAbeUlEQVR4nO1cC1vjRpYVUqlUkigwkS0DlmW3oR3LDwk/mrYBYxxnpoF0pzFJgNBxN7vZTLJJP/YxO79/7y0Z8IvH9Lez3cynA58Bu1SqU7fq3nOrSkhShAgRIkSIECFChAgRIkSIECFChAgRIkSIECFChAgRIkSIECFChAgRIkSIEOG+MCTjfvjUDf0oGJx7nnUPQCGPKp+6uR8F8qfDPyfugZNE4m+fuq0fA0Mnj549m78bz1ZW5rKfurUfA8NhqeX5ubsBDJf3P3VrPwqMHTx9tXg35ufmlw8+dWM/CoQ0E/ex4RwwfPupG/tRUGgjsXI/hofNT93YjwOx/nwvGy7OH/YfZERUmXZPG6680B4kQ53TR/cao4srj8iDZMgMkr2PDRfnVx4T9VO39iNgqKskdR8bAsM37EHa0FDIwfK9hunyhvogGRKF1Q/vQXBlbvnXh5ldEIM378VwMdF4mKmFojr9+zCcm09Y+oO0oUIcLXE/hpQ/SIYS4drafQjO/4mwT93Wj4JKdJq9D8O5xxL/1I39GBgqMeh9AuLKcsr47G0IrpCwyVZSSdc2lhcxHNzOcO6Aff42VAyVc13VVcDlC+EOaR4uLq7cxfCbJv/sbQgilBM6/S7pgw1X7kihVr7pf/6ulFBOn6dmYB09yR02nD+0nE9N4E4AQ61bTo+jACjiYtodDBdfUOfz1zSE0/WqPQU5DvQWQ4aLTxeH4xVJj7CeX6P65588KToflM0kwLyCDIh/CwyHRIBhmGoswtx8NjIPU6DRP/uJqDDe6JjjQIbyNcOVxbnFtUeItUfLoxEEGT4AGxqO1Y0jpQmGL1cWn17Ot5XDAUHQxuEow2/qD4ChAXkEzcSmGZoX85cMny4++6YpqYahsn5i1Pt802QKubV6hegqgS9QFjolnClXIAw6LPwVCxJJpURSpgGXQsmJaqGzJ8siF7wNbptNtAH0y/MA5p0tjyM5fzlKlxefHTYNBlD7h89GYuRhX1fuyPEVXTc4QNd1SrmqX4FzB95m6rD1WI7pM8AVxeETDps7zJhR1CCC6VSDFKI1WzMYxoHhkM3KymET+41IwHDxmmFCAzF0O0OqWZplWZpGVcqYdg14jzBgOZQbCpSbCSinTjHkM0pj+7CTpCmDKxL1zoDRNMPFSzJXDHljkuFd4fD5wsLxQq22cLSGJkwdLVyj1k71qWGEo7R59vJo9MMrHC+cbU/uURpadrogVPeHRDmfwVAhtBvIU4h/O8aQibE2bsNHVJ+aIuNNMRpbdtJNyvGgY1GHpNLxK9h+vNxJWcPVyP7W68AtxadhusW9yTVZnWTS/kRhWS4FvTWPMmMGQ4NkA9mcxfAyXDxbboJfEL505ekVwfnHFCbX7TbUOrZpJ03bLPZhoqznQUuIb1c2bTlpFtvQJuTYKLtx2zbloSM3Zdu1Q9/nFraZPsHQyMaghtA7XvlI0CmFtsWk6WEF79TLrj1F8eX83KVXmV98NMTcNcPF5TdgQzrh0wh04sj6G63ZphATxbpK2HraFH8lk7KJb9p+oQ1zWVUkaxc7QiCZHNUfMjBUJxgSNRtLilmVrFQqosJhz/Se09mLf433vj/J0Hw5qtDmh4HxUgYsAuvDt9QBh8gugf7RoY5B1JEg2S7J2AQ5SIFATAmGl10PP3238xyjhKQdmUObDduBP0OGxW11IkW7ZghloHb7skLbPNZmuj5VW/DdCYbQlDHh/QqAom3ueh4enlvo6yzryu0hyChDQ1oqoblkOchK1HmTd4XqhdfwLv5O5bs+1XWFdpPDUWS7AkAtLIM2nGRoXDJ0d+wxH+kWGnyWBmE04dvJCRvawfwIG/A2gHGG87kgl6vmOvAVvuCP76mhXA8UQ10qiTFkBllCnf0fisViodUrFkzRMNdOVtL7yFA6MUuhLwiKiHKrfNXoWxjG48VyoViGLrTD6Zs+4LN8n87W83JlgqFbug4X0wwxWD6bcGeluGwGbU2RrlWAYaANseXBmkScPzY2Nuq/1usbp7sB8AZLJiv2meeAS35UglvGsdyvG3XE4CJ+N8PgxwFUuZ3pmOG0lNMpNms3TGWDLftqtl4yDMZGqTh8cb1yg+y/Hc1HEDDpq+tjwQtGaUwW9kKGOhP9SyD0D2q55PB25brDKIE+lv24bBdSoOckTg26cI9RGmQoLg2SvfKQYX59hi9Fhl7PlSvJsYFqV+dvWcVYQYYTVodJbwfbZFVVrm4yzpADE4Bi6KvkfBfmoLhhsM45Ud+AE8I5FZxSDtICwuQ1w8kFvWuGsTXNoFw3tJx7yZCszmBoMKsWtycYyslfbknxYcDOv5xiaMrlgaTcyBDEt2ggAfFAs/khw1Ib1I6zkcYQAgwzGgMrK4a0ULrbhrE1ahCHU9IuXTGcKbM4ySDDcXcKDBdvpghTcpqhLHc86K8bGQ5HKYCpjfLQxce6xFCcRhHun4y7ya4G0pLB14J7P4bqV5Qaa9c2nM2QbxcnbWgmv7yd4bNJ3wQMzSPNYHSaIVjqkTqm8QzrOBkXH8W7EBCdRgtDPUS0I81RYR4Cw3vMw9gayAsHpn7GFy2QY+szt91Vzhs9H/yGHMQApaqIHRAQn97CcHEeW+QGwo0mZSQCo65GDJ1MMQRjxR4x6O6RTqWZwA5HzQmVVN06s5Piz47mwDCGyXgU+lK7fAvD0hohKpSXwhQXBvk6nbVGrTLVO9oBG1+s4UrF2tqXEDtcOfnqZhuCL30Fo0qO1wS6C3HQn6Cglsaj0c0MGT0dMiwtUfA99FgOGba8fwBD7MIT35fNroWZvKG9CHAE3soQvgO4onNOIfej2k85s+RWkkHqvgy5NmQIjQIZZNBuKNLkVgPkvIMMRZvjyHBSl/79DMHLneZ3bLNLcF2fs0SA0jh3N8Nkx8OsihupHIixpFmoj1d8j1FqlwdcpwpZSw4ZDnSqjTKs1v9PGLL6pm/Lx5SIiPUinjQrleq3N09DEDi/QNvNTl8SGi2V9iHiy+XG+IAaY6gMt4BEDqJrJzEZZ3v8yINMHzK40O/I1W3DYA7RyZEbMizUodcZMME1CgU8sXGtvG9mOHGUmaj8vFyS/ZrIPQy67Isc5paACEnGLwGEr2rfUCGtoD+lwdVX5IKlKjcwXKOrXL9kKDHd67w2IbdIFvY17kAlqfRQl/5EIEmhinbhh760uKESCcaxHjb8boZXIeka4Gm4dRSL+zWxpqBK7ZiL4ffLZ7cxfFmBMNfqi0arbwLT9ZPyl1SXZqi2S4ahDSlhkHNtp3cge/IrxxbRDYXwjXQ8ZLgOI4oRxav6Q08zgKwWxC7HGSQxXKe4myGZAGdcW/Lj8RqkzzAipJMA0+1k5bZ9i3lgaFZ2PTEI2JuCvOOCW+RhO2YxJJcMYYjq1Dvy3Tgk8GcNwnRInHmzGPrOQMgUfbXeGs7DVoMxh4vVLITjEMpuZ4hG0/kYdMppKmaXup6oxGoHNsbDym27a/MVzGY75xIwMuhPrYuk6afXmS7WvGYzdJiYHrhW5i3l/Yprln9rUEyhdQKiJozw8RNc/uNWtxImtXbHY4w3djsC3x3Q+zA0poyoEXpetu3cRVhPTg4ZvrqRH8jSJASwuPxjZgnw9WG8UqnsbNYJ9pA224YKtxohzn86rvrxSjz4Fw//alBHBVEzVEY1fGu7mwuTfPjbYobU3/JF6lzYQ4ZSNhZ2BzKUJhkq4KYOHo/jC3zJ4WoAloqL7BQslLvZhsDQBBHiukIFxaoxmDQVN/jXLwCPf6aXk3HUl0qa9G4LN+565WIhHm4kVDrwx+6/vXUk7p0NdXFud7dXLleTgmHSrq5rBuH9YrgEUN6juMSazftCYsaRIb9iCKJsHXoAGD5G0TW6xYIA3x0fWdWvyMnqSkjm+mXx6mVlfmoFErsEl3bm/2xdCrcxhhy7Hg2BEFfsgGawd5JPtinhVi0IhyUMDVtcg8HS9osNXaHIUFxRvZWhPGTIJcFwbvxY+tyXydEVD5TRyW9vPMQ+t/Lt5LIHtu3V3OLTV69OZjN0yHqAQQi3J0NziRVDv/KkzhVOu8PUJlkZlsBFADO9RJ0RhuU9yB2xq9zK5ShVHDppQ4d8sYJ2m2jztzlzdN3bjJvJX25h+MsUQ7gG1wHmZ9twDRie+gixoBiSQR3jVjaBoUPWwkFhhus6UAAX0apnHq7eDRnGrxjGRxiCDY1Jhm9W5uZXRiBG6nxOdnFZNZwi0MGYP92ExZWXk8kTBlB4HzB7lIJQOQ2SYxBrnb4JDkrRyWnoPcIlU9OMuxgLjxsapsvgaV2xiirmIVeFDaFgaQ0UwLgN4TaqI44DTT4As/KqYrru9ZpsBXHLAzMvJxJmqD/4ZWVlfv7Z/KElzWDINeh6cxq2XayD4Kep4IohmjAeK5Q7p5aIZlTvb7o4ZoAhJMioosP13dIaQ5nOaGZof9ALIAEVmlpeXp6bW75CGOAuqrH8NUrwRwwH5PIsfLNYiU8ZUf527pvluZVvEpYkzWBIpZ/LuWl0Ou/rlKjk7Xe4KtkZvndWO8nWPaaL/RKq9D+0WlXA+xTIHUPLlludXCuXa2VUYUOSabVEnHufpRQ0EX37xSw8XpvAo0czyyH2H1/IkxMx2TrdB3yx/06bwRDHkzXrmTjP8yhHI3qj71mQBIB+oSLbYZwOr/Q0HfSKo3niOoChoCrn1vBjD4U342wy4AuIndXJpONGeJ3J7Tg5uesRiYZ1TTPMgDJTGZ8BJoEqwx0V1PBhCYYlQcsNWwRakIcfgUQHGzlcUh1RWJVAZoIZORF/SnicS0HZK3YbrjZPw1odruvK6jj4cP92Cszr2ebkRKxpDoMOV41ZDHE1UQ9PA4wDiUh4pEO5/gSvxn0/wi41riH4EkkHG0JyESZTYD88Z6gSzsW1YCVDoiDSoboZO+YEN4mvtllC1jOKhWCDnluZYBiD0CUpY8+V3pwBf/Yw6q2di4mJGENNOFHs4TKU9spTNixs/zMxJNnAnPSlrQGfPAT2gBnSpVJl0pnuepD+jq/HPmCG5FCeYnjk6Sr7p2FIO3JuZJTiDmXQtSDgjZN4wAytslwZZxgPMhqXjH8aGza27DGGuFOfooz888zDJmQzI8ECfjeLdaaTGTaERAhK5B8Z6uf/6MIVDOlNeufy5AsCc9liAxhOFVzKi/UW0KVElz7/47YC4pxYNnCTleHBEAQksx1tuiza0N7BnA9XhB8Uw69zZmVE01TMnfhfZh0AI3/qlTc3N9ObPyxRPC/1/97aj4Fg+DT/2vevh2lFfh37ehZD3vx18KtAE1OCB8TwNzzw+OUVFmq1o+ezCjtiywBBdEiBVbHmf3kwWGwDQX4n3JOijGpaSI6Gnle5+gAKXv02FE9Xjs0Ivyectbj0uuLw0LF6ed5H1Cw+VS+3IiCeq1iJDrmVZWnWSJKnWZYx84gAtgHTMjKsXjRO1G2EXCX0vyJnHrleoXz10vPitQamdpD7hUUgbWSGOF3MxE0Jwb8YHrPG49Gj3YI5IVQUpuWiCZAZDzdWsEnhmYMhQ8XQQbEYRpiFYmbNVUVCKaqK7psZCvC4MzPETkJ4nhvPYeDZZxYegcYjndh4XKoY0UM6u1ytg5yeMrE/JnoltJx6ZRn4YeAtVIpncEQZgkcBDR0apXKRFgNxdZgBY0MA4Y00CveEAuz6IDmag+LKCb6IxQbjaotn+rj5sKmc6w43dAfbFp7OJsrqKi4TqCp8wgyuK7qzuqro/HrI6ZqnhRR0A7eqCO7iAkFHbCxxTLTxbZWISnHFAlpkeRpULCEnQzDUdbC7voonlBTMzEU76erq0BjwFpTAV1zugM4z8DCTwykWA8vpXHwQroWA4lZmnUWC4aZpqxTuTYcrQdBFGtxEwZPfTOfww+HhQL/0Qzgg+u87/y6JCnWiUcXhKtG0xnlDw01qqKEx8CyLc4U5OEOgEsbYH793lij0CEEz4FacoROqKY5OLSSNBfHLIqss7EsDzQWdQMT6B/QJXic5VPOguWgJ/NyQtOFEBMPMcpR/vHvXpNu1s+OMRaGV2ey7wX42+1Z7l802JZ02s9ms9jZ7Ckida3hsUwx4kkoX6xA/cY/lORR3oBeafzl73znpM7ht/bjV6mQ87ijqV85bqOI5drvWjZfFUpuhUutd9ueGocBd3nLr3elptqlxCjVh2T7l4fNorAGfa9pzuH02uw9vG3T/9J3lPTo+7m5Q6P2fsz9bq6KNUCC739RmTcTmD/nM4EM6ZhZONEcdbPnvz9NPPgxoO1/MgH32nsQ6NLWVz+fyT74D5c4pbkBCY4NyAzoaDFd/n3+SgqHeOCuZJTfoWDp5Wy75JTldgwpXHa+Vz7VOJEYcmgrSdcpx8UrRjoOtFJGWNjdPqNdLx/Jb6w7txoIgKAW72zRkuNpvxXp17VgsDqc//MQVKRG8H5wUYq4P7zvWUfBhsMoPevl8kE8H6d5zdYaw7m/Zy1+e/XgRmL0Bo88LpaXzTXmBqHsFuQupyHZeXtD2e8Viq+C7aVyvVnWiM2/XvPB0ReWNtbKJe4ZMawdu7vTCjrWpduzGFpaqfjFF9VW6ngbmbXB4DhmUgwwwhNGma5l8PkPJXqHUpd7/lNO+u9XQusVyuVBy471fw8jtaEd+eU/7/smTcst07Y5FQWPG/uO72o85165ZjnaSLO8pdCO/E2u1WlUbSsywYf+7i1yrr3lHeNSGrgfl+na6um7o5y255znA0DyiVuN8cL7X8f0zj6uSLnE2aMUTdBWc7sGWHXeDPU23Om76V+m8sFO2+lt+p0H+ZbNUs3S10dn9DzkvGPJGK17TOPYz1zKvX2c06Ee/S3jj/KeqXzhguDc7eNySIc0Tbs/Rjv10StL6/fPzbuAWmpqUibnlrKdtl2HAO/SkFOxJZGMzvnDeGKxXoQTMo0mH2tg1cynJkbLpWEbV2vFdK1soNxxNq9lbdSYYQjADb87q6XhvgMJAB9MWYi9gCnKyXWxV7GCPOlbVrXhfWQtyuj5IB236lVf2i55utctf/2cs3obC+IQa9DI4Z0VxQhuq28CQgju3urH0vmEwDm4nE8h/tYTL4PRYLrxhDnEYG5TdQp2q8OGZpTteL15ucnISi+0pfCNdqUmMa2fy1gYOsUmGvdfpBuHSer6UYdZxL0P/vde1vrLIWiyfJYIhPjvDVp3ztFneFgwdaT3IP+Y6hLPnu+v/Gis9J47WMjvn3OskS6nBVnLB4oOeu9Vkg60f+tnXSWRI4FO/2ufokYFhOr8EDNPuX8D9Olo7n1/HQEkUsp32hwdIkGGwh7siutMo+4W3RM2U5C5d1b0cVM5JIpZPGcAwWZN0R6vJm/XL45Wjo7SYrFrUYal0rK05EOWI5qG/J/XiTpdK22n7rxpGfEX3qnJ1GzNMcIfZdP7U0Q0Ovl36Ol+AoaJ1K5Xuxgkw3PfOzNLS9rG5U3xr1QpLUjZfamv6quF4nZ1iX4XuUtGGJWRYkP9i4ZPp7Rgy5Ph0yHarUggZ6tax/ASPJCswkstuegPPB8SWQChoZyaMMJqIlVKEbxRKNTwOsQAMJYVNSjfBkDkMZsRT6mBMwaV6+IIqOx47KMiCoUQc6LdinaiC4X6QP+Uoh6Dbv44V9qD+es+XWwUz6T8mp7u+X8xV/HR9u1f+L+s0FrQ9aiBDv9xgdIThwYfy92BDDgxj+DQEusKNTbfqhb5U+733YR8PXY8yxPPoWsXd/LsYcvDkVRg1oGCYOEIF0I5jhTrZLtjHwoYEx0nrHG4GOZaUAoYQnlBCgg3Te6gT6//d+utPa534vm49Pysf/VfNLw7WS8la7cK3L44HFBm6rQZu0Vwy5BREAmp/rV2KoQ1RhW28thfCf261qsPHfZBDEzYkjpUDhvx+DD1hQ659XQkyELKoOB6MIJlSPktTaf843Juh2+nge80x0IVKe9gfXCgtwRB0TXNw3te0bi59wH8dgLjxzuxeP5sOWjnZNpO9OhEMwdOg3xoyBCkELsJAhkGQguEBskBbe93bp4Ihc1SQvM4EQ9xB6hfdHxr3ZNgvmlXLoN5ZpQiFNSlMKjiTaD3wEw0IbW0qlNhgwV0+pyFD8GyxBFhASF0YpSlVa/xPsdfXzzv+k/O3P2ydabxeNs/owdMf2z++rFwsnPwBqrPRitWgX4xrG6JzJwZItXY8SDGqEerVO7GsFW5uAT2qSo4KahSu9Tc3JCkbjy0xoqXSbtlDTwNjWzCUgOGR2I2fSuL7Pb+lkb8txO2t/iV7wr/Sjs4uAjnZCexe3Xm7e3GMJ4hqR78/l8gqiE2I+Efa0Gtl4sG+ZFhHvp/Y7gZxCJ+tnWomdSYHWewaiZzKybamgm6rl+NrYiZcMRQVNH8/Oqrs5FPSz2dnnVzBvOge/94AdzBiC5U1WjubGw7JBK8f8eZJZ8c/Af4n/us3nG0X3JoEdR2ZT+pUmUoRG71Sy7OOIGyf0MtToiAyvSAW83343gIVsrHl+/mYHcv7xT08eM8crSsHDUdIJLhpIQUKduNDPhbIcm+g02xRDgp2/KyBe70qhtq2RiSHrQfpbcYJH2dIzj/4r1/76XXr0ZPX8Isfi5eKDUUaZUhoo+eX60z7uvD6Ka0/AdU2AMuf4K21va3YMSr5sxgynBLfjd/av1n0+9buSV/sbeJ7BiSrf0s8TSTaiT8dwI2aiUTiReKk/eLFb28hNlLxoGJ+O2wC2W+fHMCwtg46vV75aIM6upbtlAvl7kDD1E2S3iTa+zjgtJpb8CDnnGCo/pFYbrefnhzQ/RcvnuKd4LuhsBGG4NKs3xKJpgI3e7pPm7u7u2/AOZOfXyQOFPI20c4QnZO/vUg0MQWdYIiPdIK3akDeA1lq+FyZAlYSWVx4EDQ88BnujUMyiocrmAXZExUHADGlwe1viKPN5rkGs1iXiNccNNAFK5BVYXqFe8Dkj+96IvJD2VGGxirkZZAVYfXijiIphhZfZ3uQduJnkLZCP0EVXsMC4WFAbkMlSPQoHnWECwhmxVMMdREAMUeFUEfD58qgFQaF/BJbRyEooPfBKznEfUg9cVce/LgVnoRVoAIFF3gM4jginIoslTuOAxdinUzBPFZy9EbDkgRDhgzFjjR2EfTUKuUg0vGkLz5PivnLGENUO1ApRjJxxkGBzBViN6S++F9fIINHd6spqwx0nzpzrebvx+3/I01kwTc/nsscXTAkn/u/JZlJUrwplgpuZAhJF+hrYKjd8QTv5wxxCvimD2GMKeTd2dm7B/pfuu4GBIJV8D6o9z91U/5BwExllRrgVB7wKI0QIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRIgQIUKECBEiRPhU+F/muLt57YE4WAAAAABJRU5ErkJggg==" alt="×œ×•×’×• ×—. ×¡×‘×Ÿ" class="w-32 h-32 object-contain rounded-full">
            </div>
            <h1 class="text-3xl font-bold text-slate-800">×˜×•×¤×¡ ×ª×™×¢×•×“ ×¢×‘×•×“×” ×“×™×’×™×˜×œ×™</h1>
            <p class="text-slate-600">×—. ×¡×‘×Ÿ - ×—×•××¨×™ ×‘× ×™×Ÿ 1994 ×‘×¢"×</p>
        </header>

        <div id="progress-bar" class="w-full mb-8">
            <div class="flex items-center justify-between">
                <div id="step-1" class="progress-step progress-step-active w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">1</div>
                <div class="progress-line flex-1"></div>
                <div id="step-2" class="progress-step progress-step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">2</div>
                <div class="progress-line flex-1"></div>
                <div id="step-3" class="progress-step progress-step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">3</div>
            </div>
        </div>

        <main>
            <!-- Driver Messages Section -->
            <div id="driver-messages" class="message-box hidden">
                <p id="driver-message-text" class="font-semibold text-slate-700"></p>
                <div id="driver-message-actions" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <!-- Page 1: Order Details -->
            <div id="page-1" class="form-section p-6 space-y-6 active-page">
                <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 1: ×¤×¨×˜×™ ×”×–×× ×”</h2>
                
                <div id="existing-order-section">
                    <div>
                        <label for="driver-select" class="block mb-2 text-sm font-medium text-slate-700">×‘×—×¨ × ×”×’/×¨×›×‘:</label>
                        <select id="driver-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500">
                            <option selected disabled>-- ×‘×—×¨ ×©× --</option>
                        </select>
                    </div>
                    <div>
                        <label for="order-select" class="block mb-2 text-sm font-medium text-slate-700">×‘×—×¨ ××¡×¤×¨ ×”×–×× ×”:</label>
                        <select id="order-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option selected disabled>-- ×‘×—×¨ ×”×–×× ×” --</option>
                        </select>
                    </div>
                    <div id="order-details-container" class="hidden space-y-4 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-slate-700">×¡×™×›×•× ×¤×¨×˜×™ ×”×–×× ×”</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><strong class="font-semibold text-slate-600">××¡×¤×¨ ×”×–×× ×”:</strong> <span id="order-id-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×ª××¨×™×š:</strong> <span id="order-date-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×©× ×œ×§×•×—:</strong> <span id="customer-name-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×›×ª×•×‘×ª:</strong> <span id="customer-address-display"></span></div>
                        </div>
                        <div class="mt-4">
                            <strong class="font-semibold text-slate-600">×¤×™×¨×•×˜ ×¤×¨×™×˜×™×:</strong>
                            <div class="mt-2 rounded-lg overflow-hidden shadow-sm">
                                <table class="responsive-table w-full text-sm text-right text-slate-600">
                                    <thead class="text-xs text-slate-700 uppercase">
                                        <tr>
                                            <th scope="col">××§"×˜</th>
                                            <th scope="col">×ª×™××•×¨</th>
                                            <th scope="col">×›××•×ª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="order-items-tbody">
                                        <!-- Items will be populated here by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center my-4">
                    <span class="text-slate-500">××•</span>
                </div>

                <button type="button" id="start-new-order-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold w-full">×”×ª×—×œ ×”×–×× ×” ×—×“×©×”</button>

                <div id="new-order-section" class="hidden space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-slate-700">×¤×¨×˜×™ ×”×–×× ×” ×—×“×©×”</h3>
                    <div>
                        <label for="new-order-id-input" class="block mb-2 text-sm font-medium text-slate-700">××¡×¤×¨ ×”×–×× ×”:</label>
                        <input type="text" id="new-order-id-input" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×–×Ÿ ××¡×¤×¨ ×”×–×× ×”">
                    </div>
                    <div>
                        <label for="new-customer-name-input" class="block mb-2 text-sm font-medium text-slate-700">×©× ×œ×§×•×—:</label>
                        <input type="text" id="new-customer-name-input" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×–×Ÿ ×©× ×œ×§×•×—">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-delivery-date-input" class="block mb-2 text-sm font-medium text-slate-700">×ª××¨×™×š ××¡×¤×§×”:</label>
                            <input type="date" id="new-delivery-date-input" class="w-full p-2.5 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-delivery-time-input" class="block mb-2 text-sm font-medium text-slate-700">×©×¢×ª ××¡×¤×§×”:</label>
                            <input type="time" id="new-delivery-time-input" class="w-full p-2.5 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="site-access-select" class="block mb-2 text-sm font-medium text-slate-700">×’×™×©×” ×œ××ª×¨:</label>
                        <select id="site-access-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500">
                            <option selected disabled>-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --</option>
                            <option value="×¢×‘×•×“×ª ×× ×•×£">×¢×‘×•×“×ª ×× ×•×£</option>
                            <option value="×”×¢×‘×¨×ª ×¦×™×•×“">×”×¢×‘×¨×ª ×¦×™×•×“</option>
                            <option value="××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª">××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª</option>
                        </select>
                    </div>
                    <button type="button" id="back-to-existing-order-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold w-full">×—×–×•×¨ ×œ×‘×—×™×¨×ª ×”×–×× ×” ×§×™×™××ª</button>
                </div>
            </div>

            <!-- Page 2: Field Log -->
            <div id="page-2" class="hidden form-section p-6 space-y-6">
                <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 2: ×ª×™×¢×•×“ ××™×¨×•×¢×™× ×‘×©×˜×—</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="wait-start-time" class="block mb-2 text-sm font-medium text-slate-700">×ª×—×™×œ×ª ×”××ª× ×”:</label>
                        <input type="time" id="wait-start-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="wait-end-time" class="block mb-2 text-sm font-medium text-slate-700">×¡×™×•× ×”××ª× ×”:</label>
                        <input type="time" id="wait-end-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="crane-start-time" class="block mb-2 text-sm font-medium text-slate-700">×ª×—×™×œ×ª ×¢×‘×•×“×ª ×× ×•×£:</label>
                        <input type="time" id="crane-start-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="crane-end-time" class="block mb-2 text-sm font-medium text-slate-700">×¡×™×•× ×¢×‘×•×“×ª ×× ×•×£:</label>
                        <input type="time" id="crane-end-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-lg font-bold text-blue-800">
                    <div><strong class="font-semibold text-slate-600">×¡×”"×› ×–××Ÿ ×”××ª× ×”:</strong> <span id="total-wait-time">0 ×“×§×•×ª</span></div>
                    <div><strong class="font-semibold text-slate-600">×¡×”"×› ×–××Ÿ ×× ×•×£:</strong> <span id="total-crane-time">0 ×“×§×•×ª</span></div>
                </div>

                <div>
                    <label class="block mb-2 text-sm font-medium text-slate-700">×¡×•×’ ×¢×‘×•×“×ª ×× ×•×£:</label>
                    <div id="crane-work-type-group" class="flex flex-wrap gap-3">
                        <button type="button" data-value="×¢×‘×•×“×” ×‘××ª×¨ ×”×œ×§×•×—" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸ—ï¸ ×¢×‘×•×“×” ×‘××ª×¨ ×”×œ×§×•×—</button>
                        <button type="button" data-value="×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸšš ×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨</button>
                        <button type="button" data-value="××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ ××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª</button>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">×”×—×–×¨×•×ª ××œ×§×•×—:</h3>
                    <div id="returns-container" class="space-y-3"></div>
                    <button type="button" id="add-return-item-btn" class="mt-2 text-sm text-blue-600 font-semibold hover:text-blue-800">+ ×”×•×¡×£ ×¤×¨×™×˜ ×œ×”×—×–×¨×”</button>
                </div>
                
                <div class="border-t pt-4">
                     <h3 class="text-lg font-semibold text-slate-700 mb-2">×”×¢×¨×•×ª ×•×¦×™×œ×•××™×:</h3>
                    <textarea id="driver-notes" rows="3" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª ×—×•×¤×©×™×•×ª..."></textarea>
                    <button type="button" id="open-camera-btn" class="mt-2 inline-flex items-center gap-2 btn-secondary px-4 py-2 rounded-lg text-sm">
                        ğŸ“¸ ×¦×¨×£ ×ª××•× ×”
                    </button>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                    <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </div>
            </div>

            <!-- Page 3: Signature & Finish -->
            <div id="page-3" class="hidden form-section p-6 space-y-6">
                 <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 3: ××™×©×•×¨ ×•×¡×™×•×</h2>
                <div>
                    <label for="receiver-name" class="block mb-2 text-sm font-medium text-slate-700">×©× ××§×‘×œ ×”×¡×—×•×¨×” / ××™×© ×§×©×¨:</label>
                    <input type="text" id="receiver-name" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×§×œ×“ ××ª ×©× ×”××§×‘×œ">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-slate-700">×—×ª×™××ª ×œ×§×•×—:</label>
                    <div class="w-full h-48 md:h-64 rounded-lg signature-pad-container shadow-inner p-2">
                        <canvas id="signature-pad" class="w-full h-full bg-white/70 rounded"></canvas>
                    </div>
                    <button type="button" id="clear-signature-btn" class="mt-2 text-sm text-red-600 font-semibold hover:text-red-800">× ×§×” ×—×ª×™××”</button>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">×”×•×“×¢×•×ª ×œ××—×œ×§×ª ×¡×™×“×•×¨:</h3>
                    <div class="flex flex-wrap gap-3">
                        <button type="button" id="whatsapp-complete-btn" class="whatsapp-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <i class="fab fa-whatsapp"></i> ×¢×“×›×Ÿ ×¡×™×•× ×¤×¢×•×œ×”
                        </button>
                        <button type="button" id="whatsapp-delay-btn" class="whatsapp-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <i class="fab fa-whatsapp"></i> ×“×•×•×— ×¢×œ ×¢×™×›×•×‘
                        </button>
                        <button type="button" id="whatsapp-issue-btn" class="whatsapp-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                            <i class="fab fa-whatsapp"></i> ×“×•×•×— ×¢×œ ×‘×¢×™×”
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div id="navigation-controls" class="mt-8 flex justify-between items-center">
                <button type="button" id="back-btn" class="btn-secondary px-6 py-2 rounded-lg font-semibold" disabled>×—×–×¨×”</button>
                <button type="button" id="next-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">×”×‘×</button>
                <button type="button" id="submit-btn" class="hidden btn-primary bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-bold">×©×œ×— ×•×¡×™×™×</button>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="transfer-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 modal-content">
            <h3 class="text-xl font-semibold">×¤×¨×˜×™ ×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨</h3>
            <div>
                <label for="transfer-from" class="block mb-2 text-sm font-medium text-slate-700">×”×¢×‘×¨×” ×××ª×¨ (×›×ª×•×‘×ª × ×•×›×—×™×ª):</label>
                <input type="text" id="transfer-from" class="w-full p-2.5 border border-slate-300 rounded-lg">
            </div>
            <div>
                <label for="transfer-to" class="block mb-2 text-sm font-medium text-slate-700">××œ ××ª×¨ (×›×ª×•×‘×ª ×™×¢×“):</label>
                <input type="text" id="transfer-to" class="w-full p-2.5 border border-slate-300 rounded-lg">
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-transfer-btn" type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm">×‘×™×˜×•×œ</button>
                <button id="confirm-transfer-btn" type="button" class="btn-primary px-4 py-2 rounded-lg text-sm">××™×©×•×¨</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center space-y-4 modal-content">
             <div class="text-6xl">âœ…</div>
            <h3 class="text-2xl font-bold">×”×˜×•×¤×¡ × ×©×œ×— ×‘×”×¦×œ×—×”!</h3>
            <p class="text-slate-600">×§×•×‘×¥ PDF × ×•×¦×¨ ×•× ×©××¨. ×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘××¢×¨×›×ª. × ×™×ª×Ÿ ×œ×¡×’×•×¨ ××ª ×”×—×œ×•×Ÿ.</p>
            <div class="pt-4">
                 <button id="close-confirmation-btn" type="button" class="btn-primary w-full px-6 py-2 rounded-lg font-semibold">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Display (for app-wide messages like location updates) -->
    <div id="app-message" class="fixed top-4 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-800 p-3 rounded-lg shadow-md z-50 hidden transition-opacity duration-300" role="alert">
        <p id="app-message-text" class="font-semibold text-center"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MOCK_DATA = {
                drivers: [
                    { name: '×©××•×œ', vehicle: '61541002' },
                    { name: '×—×›××ª', vehicle: '61541002' },
                    { name: '×¤××œ×— ×”×•×‘×œ×•×ª ×¢×•×‘×™×™×“×”', vehicle: '97-405-86' },
                    { name: '×¢×œ××', vehicle: '' },
                    { name: '×™×•××‘', vehicle: '47818801' },
                    { name: '×¢×œ×™', vehicle: '65151701' },
                    { name: '××•×¡×™×™×“', vehicle: '63-511-31' },
                    { name: '× ×™×¡×™× ××’×™×“×™×©', vehicle: '' },
                ],
                orders: [
                    { id: '6207015', customer: '×™×©×¨××œ ×™×©×¨××œ×™', address: '×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ', items: [{sku: '101', desc: '××©×˜×— ×‘×œ×•×§×™×', qty: 2}, {sku: '205', desc: '×©×§ ××œ×˜', qty: 10}] },
                    { id: '6207018', customer: '××©×” ×›×”×Ÿ', address: '×–×‘×•×˜×™× ×¡×§×™ 15, ×ª×œ ××‘×™×‘', items: [{sku: '310', desc: '×—×‘×™×ª ×¤×§×“×•×Ÿ', qty: 1}, {sku: '402', desc: '××©×˜×— ×¡×‘×Ÿ', qty: 3}] },
                    { id: '6207021', customer: '×“×•×“ ×œ×•×™', address: '×”× ×©×™× 1, ×¨×¢× × ×”', items: [{sku: '101', desc: '××©×˜×— ×‘×œ×•×§×™×', qty: 5}] }
                ],
                returnableItems: ["×©×§ ×¤×§×“×•×Ÿ", "××©×˜×— ×¡×‘×Ÿ", "××©×˜×— ×‘×œ×•×§×™×", "×—×‘×™×ª ×¤×§×“×•×Ÿ", "×©×§ ×¤×¡×•×œ×ª"]
            };

            const WHATSAPP_DISPATCH_NUMBER = '972508860896'; // ××¡×¤×¨ ×•×•××˜×¡××¤ ×œ××—×œ×§×ª ×¡×™×“×•×¨
            // ×•×“× ×©×›×ª×•×‘×ª ×”-Apps Script ×›××Ÿ ××“×•×™×§×ª ×•×–×”×” ×œ×–×• ×©×¤×¨×¡×ª!
            const appsScriptWebAppUrl = 'https://script.google.com/macros/s/AKfycbwp7lYX4uoeDLGm2gJo4l8ZkKC103fkmbl7-tv2F8RuTOgkU0eXZ9xQFHARHVAy2X_b/exec'; 

            const state = {
                currentPage: 1,
                isNewOrderMode: false,
                formData: {
                    driver: null,
                    vehicle: null,
                    orderId: null,
                    customerName: null,
                    customerAddress: null,
                    items: [], 
                    
                    newOrderId: null,
                    newCustomerName: null,
                    newDeliveryDate: null,
                    newDeliveryTime: null,
                    siteAccessType: null,

                    waitStartTime: null,
                    waitEndTime: null,
                    craneStartTime: null,
                    craneEndTime: null,
                    craneWorkType: null,
                    transferFrom: null,
                    transferTo: null,
                    returns: [],
                    notes: '',
                    images: [],
                    receiverName: null,
                    signature: null,
                    location: null, // Will store {lat, lon, timestamp}
                    serialNumber: `SBN-${Date.now()}`,
                    totalWaitMinutes: 0, // Added for calculations
                    totalCraneMinutes: 0 // Added for calculations
                },
                driverMessageTimeout: null // For clearing driver messages
            };

            const pages = [document.getElementById('page-1'), document.getElementById('page-2'), document.getElementById('page-3')];
            const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            const driverSelect = document.getElementById('driver-select');
            const orderSelect = document.getElementById('order-select');
            const existingOrderSection = document.getElementById('existing-order-section');
            const startNewOrderBtn = document.getElementById('start-new-order-btn');
            const newOrderSection = document.getElementById('new-order-section');
            const backToExistingOrderBtn = document.getElementById('back-to-existing-order-btn');

            const newOrderIdInput = document.getElementById('new-order-id-input');
            const newCustomerNameInput = document.getElementById('new-customer-name-input');
            const newDeliveryDateInput = document.getElementById('new-delivery-date-input');
            const newDeliveryTimeInput = document.getElementById('new-delivery-time-input');
            const siteAccessSelect = document.getElementById('site-access-select');
            const orderDetailsContainer = document.getElementById('order-details-container');

            const totalWaitTimeDisplay = document.getElementById('total-wait-time');
            const totalCraneTimeDisplay = document.getElementById('total-crane-time');

            const driverMessagesContainer = document.getElementById('driver-messages');
            const driverMessageText = document.getElementById('driver-message-text');
            const driverMessageActions = document.getElementById('driver-message-actions');


            let signaturePad = null;

            function initialize() {
                populateDrivers();
                setupEventListeners();
                parseUrlParams(); // Check for orderId/driverName in URL
                updatePage(); // This is crucial for showing the first page
                requestLocation(); // Initial location request
            }

            function parseUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const orderIdParam = params.get('orderId');
                const driverNameParam = params.get('driverName');

                if (orderIdParam && driverNameParam) {
                    state.formData.orderId = orderIdParam;
                    state.formData.driver = driverNameParam;

                    // Try to find the driver in MOCK_DATA
                    const selectedDriver = MOCK_DATA.drivers.find(d => d.name === driverNameParam);
                    if (selectedDriver) {
                        state.formData.vehicle = selectedDriver.vehicle;
                        driverSelect.value = selectedDriver.name; // Set dropdown
                        populateOrders();
                        // Find and select the order
                        const selectedOrder = MOCK_DATA.orders.find(o => o.id === orderIdParam);
                        if (selectedOrder) {
                            state.formData.customerName = selectedOrder.customer;
                            state.formData.customerAddress = selectedOrder.address;
                            state.formData.items = selectedOrder.items;
                            orderSelect.value = selectedOrder.id; // Set dropdown

                            document.getElementById('order-details-container').classList.remove('hidden');
                            document.getElementById('order-id-display').textContent = selectedOrder.id;
                            document.getElementById('order-date-display').textContent = new Date().toLocaleDateString('he-IL');
                            document.getElementById('customer-name-display').textContent = selectedOrder.customer;
                            document.getElementById('customer-address-display').textContent = selectedOrder.address;
                            
                            const tbody = document.getElementById('order-items-tbody');
                            tbody.innerHTML = '';
                            selectedOrder.items.forEach(item => {
                                tbody.innerHTML += `
                                    <tr class="bg-white border-b">
                                        <td class="px-6 py-4">${item.sku}</td>
                                        <td class="px-6 py-4">${item.desc}</td>
                                        <td class="px-6 py-4">${item.qty}</td>
                                    </tr>
                                `;
                            });
                            showAppMessage(`×”×–×× ×” ××¡×¤×¨ ${state.formData.orderId} × ×˜×¢× ×” ××•×˜×•××˜×™×ª ×¢×‘×•×¨ ${state.formData.driver}.`, 'success');
                        } else {
                            showAppMessage('××¡×¤×¨ ×”×–×× ×” ×œ× × ××¦× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ ×”×–×× ×” ×™×“× ×™×ª.', 'error');
                        }
                    } else {
                        showAppMessage('×©× ×”× ×”×’ ×œ× × ××¦× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ × ×”×’ ×™×“× ×™×ª.', 'error');
                    }
                }
            }

            function populateDrivers() {
                MOCK_DATA.drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.name;
                    option.textContent = `${driver.name}${driver.vehicle ? ` (${driver.vehicle})` : ''}`;
                    driverSelect.appendChild(option);
                });
            }

            function populateOrders() {
                orderSelect.innerHTML = '<option selected disabled>-- ×‘×—×¨ ×”×–×× ×” --</option>';
                MOCK_DATA.orders.forEach(order => {
                     const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `×”×–×× ×” ${order.id} - ${order.customer}`;
                    orderSelect.appendChild(option);
                });
                orderSelect.disabled = false;
            }

            function updatePage() {
                pages.forEach((page, index) => {
                    const isCurrentPage = index + 1 === state.currentPage;
                    page.classList.toggle('hidden', !isCurrentPage);
                    page.classList.toggle('active-page', isCurrentPage);
                    if (isCurrentPage && page.id === 'page-3') {
                        setTimeout(() => {
                            const canvas = document.getElementById('signature-pad');
                            if (!signaturePad) {
                                signaturePad = new SignaturePad(canvas);
                            }
                            const ratio = Math.max(window.devicePixelRatio || 1, 1);
                            canvas.width = canvas.offsetWidth * ratio;
                            canvas.height = canvas.offsetHeight * ratio;
                            canvas.getContext("2d").scale(ratio, ratio);
                            signaturePad.clear();
                            if (state.formData.signature) {
                                signaturePad.fromDataURL(state.formData.signature);
                            }
                        }, 100);
                    }
                });
                steps.forEach((step, index) => {
                    step.classList.toggle('progress-step-active', index < state.currentPage);
                    step.classList.toggle('progress-step-inactive', index >= state.currentPage);
                });

                backBtn.disabled = state.currentPage === 1;
                nextBtn.classList.toggle('hidden', state.currentPage === 3);
                submitBtn.classList.toggle('hidden', state.currentPage !== 3);

                // Update calculated times on page 2
                if (state.currentPage === 2) {
                    calculateAndDisplayTimes();
                    checkDriverPerformance(); // Check and display messages
                } else {
                    hideDriverMessage(); // Hide messages when not on page 2
                }

                if (state.currentPage === 1 && state.formData.driver) {
                    showAppMessage(`×‘×¨×•×š ×”×‘×, ${state.formData.driver}! ×× × ×‘×—×¨ ×”×–×× ×” ××• ×”×ª×—×œ ×—×“×©×”.`, 'info');
                } else if (state.currentPage === 2 && state.formData.driver) {
                    const progressPercentage = Math.floor((state.currentPage / pages.length) * 100);
                    showAppMessage(`×›×œ ×”×›×‘×•×“ ${state.formData.driver}, ×¢×‘×¨×ª ${progressPercentage}% ××”×˜×•×¤×¡!`, 'success');
                } else if (state.currentPage === 3 && state.formData.driver) {
                     showAppMessage(`×›××¢×˜ ×¡×™×™××ª, ${state.formData.driver}! ×× × ×§×‘×œ ×—×ª×™××” ××”×œ×§×•×—.`, 'info');
                }

                // Show/hide new order section
                existingOrderSection.classList.toggle('hidden', state.isNewOrderMode);
                newOrderSection.classList.toggle('hidden', !state.isNewOrderMode);
                startNewOrderBtn.classList.toggle('hidden', state.isNewOrderMode);
            }
            
            function showAppMessage(message, type = 'info') {
                const messageDiv = document.getElementById('app-message');
                const messageText = document.getElementById('app-message-text');
                messageText.textContent = message;

                messageDiv.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-md z-50 transition-opacity duration-300';
                if (type === 'success') {
                    messageDiv.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageDiv.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageDiv.classList.add('bg-blue-100', 'text-blue-800');
                }

                messageDiv.classList.remove('hidden');
                messageDiv.style.opacity = '1';

                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => messageDiv.classList.add('hidden'), 300);
                }, 5000);
            }

            function showDriverMessage(message, type = 'info', actions = []) {
                clearTimeout(state.driverMessageTimeout); // Clear any existing timeout
                driverMessagesContainer.classList.remove('hidden', 'error');
                driverMessageText.textContent = message;
                driverMessageActions.innerHTML = ''; // Clear previous actions

                if (type === 'error') {
                    driverMessagesContainer.classList.add('error');
                }

                actions.forEach(action => {
                    const button = document.createElement('button');
                    button.textContent = action.text;
                    button.className = `whatsapp-btn px-4 py-2 rounded-lg text-sm flex items-center gap-2`;
                    button.innerHTML = `<i class="fab fa-whatsapp"></i> ${action.text}`;
                    button.onclick = () => sendWhatsAppMessage(action.message);
                    driverMessageActions.appendChild(button);
                });

                // Set a timeout to hide the message after a few seconds if no actions are present
                if (actions.length === 0) {
                    state.driverMessageTimeout = setTimeout(() => {
                        hideDriverMessage();
                    }, 10000); // Hide after 10 seconds if no actions
                }
            }

            function hideDriverMessage() {
                driverMessagesContainer.classList.add('hidden');
                driverMessageText.textContent = '';
                driverMessageActions.innerHTML = '';
            }

            function calculateTimeDifference(startTime, endTime) {
                if (!startTime || !endTime) return 0;
                const start = new Date(`2000/01/01 ${startTime}`);
                const end = new Date(`2000/01/01 ${endTime}`);
                const diffMs = end - start;
                return Math.max(0, Math.round(diffMs / (1000 * 60))); // Difference in minutes
            }

            function calculateAndDisplayTimes() {
                const waitStart = document.getElementById('wait-start-time').value;
                const waitEnd = document.getElementById('wait-end-time').value;
                const craneStart = document.getElementById('crane-start-time').value;
                const craneEnd = document.getElementById('crane-end-time').value;

                const totalWaitMinutes = calculateTimeDifference(waitStart, waitEnd);
                const totalCraneMinutes = calculateTimeDifference(craneStart, craneEnd);

                totalWaitTimeDisplay.textContent = `${totalWaitMinutes} ×“×§×•×ª`;
                totalCraneTimeDisplay.textContent = `${totalCraneMinutes} ×“×§×•×ª`;

                state.formData.totalWaitMinutes = totalWaitMinutes;
                state.formData.totalCraneMinutes = totalCraneMinutes;
            }

            function checkDriverPerformance() {
                const driverName = state.formData.driver || '× ×”×’ ×™×§×¨';
                const totalWaitMinutes = state.formData.totalWaitMinutes || 0;
                const totalCraneMinutes = state.formData.totalCraneMinutes || 0;

                // Check for excessive wait time
                if (totalWaitMinutes > 50) {
                    showDriverMessage(
                        `×“×•×•×—, ${driverName}: ×©×¢×•×ª ×”××ª× ×”/×¢×™×›×•×‘ ××¢×œ 50 ×“×§×•×ª! ×”×× ××—×œ×§×ª ×¡×™×“×•×¨ ××•×“×¢×ª ×¢×œ ×¢×™×›×•×‘ ×¨×¦×™× ×™?`,
                        'error',
                        [{ text: '×¢×“×›×Ÿ ××—×œ×§×ª ×¡×™×“×•×¨', message: `×¢×™×›×•×‘ ×¨×¦×™× ×™ ×‘×”×–×× ×” ${state.formData.orderId || state.formData.newOrderId} ×¢×‘×•×¨ ${driverName}. ×–××Ÿ ×”××ª× ×”: ${totalWaitMinutes} ×“×§×•×ª. ×× × ×‘×“×•×§.` }]
                    );
                    return;
                }

                // Check for illogical crane/wait times (simple example)
                if (totalCraneMinutes > 0 && totalWaitMinutes > totalCraneMinutes * 2) { // If wait time is more than double crane time
                    showDriverMessage(
                        `${driverName}, ×œ× ×”×’×™×•× ×™ ×©×¢×•×ª ×¤×¨×™×§×” ×œ× ××“×•×™×§×•×ª! ×–××Ÿ ×”××ª× ×” (${totalWaitMinutes} ×“×§×•×ª) ××¨×•×š ××©××¢×•×ª×™×ª ××–××Ÿ ×”×× ×•×£ (${totalCraneMinutes} ×“×§×•×ª). ×× × ×‘×“×•×§ ×©×•×‘.`,
                        'error',
                        [{ text: '×™×© ×‘×¢×™×” ×‘×©×¢×•×ª', message: `×™×© ×‘×¢×™×” ×‘×©×¢×•×ª ×©×”×•×–× ×• ×‘×”×–×× ×” ${state.formData.orderId || state.formData.newOrderId} ×¢×œ ×™×“×™ ${driverName}. ×× × ×‘×“×•×§.` }]
                    );
                    return;
                }

                // General encouragement
                if (state.currentPage === 2 && driverName) {
                    showDriverMessage(`×›×œ ×”×›×‘×•×“, ${driverName}! ×”××©×š ×‘×¢×‘×•×“×” ××¦×•×™× ×ª!`);
                }
            }


            function sendWhatsAppMessage(message) {
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${WHATSAPP_DISPATCH_NUMBER}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
            }

            function saveFormData() {
                state.formData.waitStartTime = document.getElementById('wait-start-time').value;
                state.formData.waitEndTime = document.getElementById('wait-end-time').value;
                state.formData.craneStartTime = document.getElementById('crane-start-time').value;
                state.formData.craneEndTime = document.getElementById('crane-end-time').value;
                state.formData.notes = document.getElementById('driver-notes').value;
                state.formData.receiverName = document.getElementById('receiver-name').value;
                
                if (signaturePad && !signaturePad.isEmpty()) {
                    state.formData.signature = signaturePad.toDataURL();
                } else {
                    state.formData.signature = null;
                }

                if (state.isNewOrderMode) {
                    state.formData.orderId = newOrderIdInput.value; // Use this for PDF naming
                    state.formData.customerName = newCustomerNameInput.value; // Use this for PDF
                    state.formData.newOrderId = newOrderIdInput.value;
                    state.formData.newCustomerName = newCustomerNameInput.value;
                    state.formData.newDeliveryDate = newDeliveryDateInput.value;
                    state.formData.newDeliveryTime = newDeliveryTimeInput.value;
                    state.formData.siteAccessType = siteAccessSelect.value;
                }

                // Ensure calculated times are saved
                calculateAndDisplayTimes();
            }
            
            function handleNavigation(direction) {
                 if (direction === 'next' && state.currentPage < 3) {
                     if(validatePage()) {
                        saveFormData();
                        state.currentPage++;
                     }
                } else if (direction === 'back' && state.currentPage > 1) {
                    saveFormData();
                    state.currentPage--;
                }
                updatePage();
            }
            
            function validatePage() {
                if(state.currentPage === 1) {
                    if (state.isNewOrderMode) {
                        if (!newOrderIdInput.value.trim() || !newCustomerNameInput.value.trim() || !newDeliveryDateInput.value || !newDeliveryTimeInput.value || siteAccessSelect.value === '-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --') {
                            showAppMessage('×× × ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”×”×–×× ×” ×”×—×“×©×”.', 'error');
                            return false;
                        }
                    } else {
                        if(!state.formData.orderId) {
                            showAppMessage('×™×© ×œ×‘×—×•×¨ ×”×–×× ×” ×œ×¤× ×™ ×”××¢×‘×¨ ×œ×©×œ×‘ ×”×‘×.', 'error');
                            return false;
                        }
                    }
                }
                if(state.currentPage === 3) {
                     if(document.getElementById('receiver-name').value.trim() === '') {
                        showAppMessage('×™×© ×œ×”×–×™×Ÿ ××ª ×©× ××§×‘×œ ×”×¡×—×•×¨×”.', 'error');
                        return false;
                    }
                    if(signaturePad && signaturePad.isEmpty()) {
                        showAppMessage('×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×”×©×œ×™×—×”.', 'error');
                        return false;
                    }
                }
                return true;
            }

            function addReturnItem() {
                const returnId = `return-${Date.now()}`;
                const container = document.createElement('div');
                container.id = returnId;
                container.className = 'flex items-center gap-2';

                const select = document.createElement('select');
                select.className = 'w-2/3 p-2 border border-slate-300 rounded-lg bg-slate-50 return-item-select';
                select.innerHTML = '<option disabled selected>×‘×—×¨ ×¤×¨×™×˜...</option>';
                MOCK_DATA.returnableItems.forEach(item => {
                    select.innerHTML += `<option value="${item}">${item}</option>`;
                });

                const input = document.createElement('input');
                input.type = 'number';
                input.min = 1;
                input.placeholder = '×›××•×ª';
                input.className = 'w-1/3 p-2 border border-slate-300 rounded-lg return-item-qty';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'âŒ';
                removeBtn.className = 'text-sm';
                removeBtn.onclick = () => {
                    document.getElementById(returnId).remove();
                    state.formData.returns = state.formData.returns.filter(r => r.id !== returnId);
                };
                
                container.append(select, input, removeBtn);
                document.getElementById('returns-container').appendChild(container);

                const returnObject = { id: returnId, item: '', qty: 0 };
                state.formData.returns.push(returnObject);
                select.onchange = (e) => returnObject.item = e.target.value;
                input.onchange = (e) => returnObject.qty = e.target.value;
            }

            function requestLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            state.formData.location = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                timestamp: new Date().toISOString()
                            };
                            showAppMessage(`××™×§×•× × ×”×’ ×ª×•×¢×“: ×§×• ×¨×•×—×‘ ${position.coords.latitude.toFixed(4)}, ×§×• ××•×¨×š ${position.coords.longitude.toFixed(4)}`, 'success');
                        },
                        (error) => { 
                            state.formData.location = "Unavailable";
                            showAppMessage(`×©×’×™××ª ××™×§×•×: ${error.message}. ×× × ×•×•×“× ×©×”×¨×©××ª ××™×§×•× ××•×¤×¢×œ×ª.`, 'error');
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                     state.formData.location = "Not supported";
                     showAppMessage('×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.', 'error');
                }
            }
            
            async function handleSubmit() {
                if (!validatePage()) return;
                saveFormData();
                
                // Re-request location just before submission for accuracy
                requestLocation(); 
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pdfTemplate = document.createElement('div');
                pdfTemplate.style.width = '210mm'; // A4 width
                pdfTemplate.style.padding = '10mm'; // Reduced padding
                pdfTemplate.style.fontFamily = 'Assistant, sans-serif';
                pdfTemplate.style.direction = 'rtl';
                pdfTemplate.style.fontSize = '9px'; // Global font size for PDF template
                // Temporarily add the template to the body for html2canvas to render its styles
                document.body.appendChild(pdfTemplate); 
                
                const orderIdToDisplay = state.isNewOrderMode ? state.formData.newOrderId : state.formData.orderId;
                const customerNameToDisplay = state.isNewOrderMode ? state.formData.newCustomerName : state.formData.customerName;
                const deliveryDateToDisplay = state.isNewOrderMode ? new Date(state.formData.newDeliveryDate).toLocaleDateString('he-IL') : (state.formData.orderDate || new Date().toLocaleDateString('he-IL'));
                const deliveryTimeToDisplay = state.isNewOrderMode ? state.formData.newDeliveryTime : (state.formData.orderTime || '×œ× ×¦×•×™×Ÿ');
                const customerAddressToDisplay = state.isNewOrderMode ? '×œ× ×¦×•×™×Ÿ' : state.formData.customerAddress;
                const siteAccessTypeToDisplay = state.isNewOrderMode ? state.formData.siteAccessType : '×œ× ×¦×•×™×Ÿ';

                const locationDisplay = state.formData.location && state.formData.location.lat ? 
                    `×§×• ×¨×•×—×‘ ${state.formData.location.lat.toFixed(4)}, ×§×• ××•×¨×š ${state.formData.location.lon.toFixed(4)}` : 
                    `××™×§×•× ×œ× ×–××™×Ÿ`;

                // Build the PDF content with enhanced styling and tables
                let pdfContentHtml = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #004c99; padding-bottom: 5px; margin-bottom: 8px;">
                        <img src="${document.querySelector('header img').src}" style="width: 25mm; height: 25mm; object-fit: contain;">
                        <div style="text-align: left; color: #004c99;">
                            <h1 style="font-size: 18px; font-weight: bold; margin: 0;">×—. ×¡×‘×Ÿ - ×—×•××¨×™ ×‘× ×™×Ÿ 1994 ×‘×¢"×</h1>
                            <div class="pdf-header-info">
                                <p>×¡× ×™×£ 1: ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ | ×˜×œ×¤×•×Ÿ: 09-7602010 | ×¤×§×¡: 09-7429786</p>
                                <p>×¡× ×™×£ 2: ×”×—×¨×© 10, × ×•×•×” × ×××Ÿ | ×˜×œ×¤×•×Ÿ: 09-740575 | ×¤×§×¡: 09-7402571</p>
                                <p>×›×ª×•×‘×ª ×œ××›×ª×‘×™×: ×ª.×“ 122, ×”×•×“ ×”×©×¨×•×Ÿ 4510101</p>
                                <p>××™××™×™×œ: info@saban94.co.il</p>
                            </div>
                        </div>
                    </div>
                    <h2 style="text-align: center; font-size: 16px; font-weight: bold; margin: 10px 0; text-decoration: underline; color: #007bff;">×ª×¢×•×“×ª ×¢×‘×•×“×” / ××©×œ×•×—</h2>
                    <p style="text-align: left; font-size: 10px; margin-bottom: 3px;"><strong class="pdf-data-label">××¡×¤×¨ ××¡××›×ª×:</strong> <span class="pdf-data-value">${state.formData.serialNumber}</span></p>
                    <p style="text-align: left; font-size: 10px; margin-bottom: 8px;"><strong class="pdf-data-label">×ª××¨×™×š ×”×¤×§×”:</strong> <span class="pdf-data-value">${new Date().toLocaleDateString('he-IL')}</span></p>
                    
                    <div style="border: 1px solid #cce7f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; background-color: rgba(240, 248, 255, 0.5);">
                        <h3 class="pdf-section-title">×¤×¨×˜×™ ×”×–×× ×”</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 10px;">
                            <div><strong class="pdf-data-label">×©× × ×”×’:</strong> <span class="pdf-data-value">${state.formData.driver} (${state.formData.vehicle || '×œ×œ× ×¨×›×‘'})</span></div>
                            <div><strong class="pdf-data-label">××¡' ×”×–×× ×”:</strong> <span class="pdf-data-value">${orderIdToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×©× ×œ×§×•×—:</strong> <span class="pdf-data-value">${customerNameToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×›×ª×•×‘×ª:</strong> <span class="pdf-data-value">${customerAddressToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×ª××¨×™×š ××¡×¤×§×”:</strong> <span class="pdf-data-value">${deliveryDateToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×©×¢×ª ××¡×¤×§×”:</strong> <span class="pdf-data-value">${deliveryTimeToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×’×™×©×” ×œ××ª×¨:</strong> <span class="pdf-data-value">${siteAccessTypeToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                        </div>
                    </div>

                    <div style="border: 1px solid #cce7f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; background-color: rgba(240, 248, 255, 0.5);">
                        <h3 class="pdf-section-title">×ª×™×¢×•×“ ×–×× ×™×</h3>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>×¤×¢×•×œ×”</th>
                                    <th>×ª×—×™×œ×ª</th>
                                    <th>×¡×™×•×</th>
                                    <th>×¡×”"×› (×“×§×•×ª)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>×–××Ÿ ×”××ª× ×”</strong></td>
                                    <td><span style="font-size: 10px; font-weight: bold;">${state.formData.waitStartTime || '×œ× ×¦×•×™×Ÿ'}</span></td>
                                    <td><span style="font-size: 10px; font-weight: bold;">${state.formData.waitEndTime || '×œ× ×¦×•×™×Ÿ'}</span></td>
                                    <td><span style="font-size: 10px; font-weight: bold; color: #007bff;">${state.formData.totalWaitMinutes || 0}</span></td>
                                </tr>
                                <tr>
                                    <td><strong>×–××Ÿ ×× ×•×£</strong></td>
                                    <td><span style="font-size: 10px; font-weight: bold;">${state.formData.craneStartTime || '×œ× ×¦×•×™×Ÿ'}</span></td>
                                    <td><span style="font-size: 10px; font-weight: bold;">${state.formData.craneEndTime || '×œ× ×¦×•×™×Ÿ'}</span></td>
                                    <td><span style="font-size: 10px; font-weight: bold; color: #007bff;">${state.formData.totalCraneMinutes || 0}</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="border: 1px solid #cce7f5; padding: 10px; border-radius: 8px; margin-bottom: 10px; background-color: rgba(240, 248, 255, 0.5);">
                        <h3 class="pdf-section-title">×¤×¨×˜×™ ×¢×‘×•×“×” ×•×”×—×–×¨×•×ª</h3>
                        <p style="font-size: 10px; margin-bottom: 5px;"><strong class="pdf-data-label">×¡×•×’ ×¢×‘×•×“×ª ×× ×•×£:</strong> <span class="pdf-data-value">${state.formData.craneWorkType || '×œ× ×¦×•×™×Ÿ'}</span></p>
                        ${state.formData.craneWorkType === '×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨' ? `<p style="font-size: 10px;"><strong class="pdf-data-label">×”×•×¢×‘×¨ ×:</strong> <span class="pdf-data-value">${state.formData.transferFrom || '×œ× ×¦×•×™×Ÿ'}</span><br><strong class="pdf-data-label">××œ:</strong> <span class="pdf-data-value">${state.formData.transferTo || '×œ× ×¦×•×™×Ÿ'}</span></p>` : ''}
                        
                        ${state.formData.returns.filter(r=>r.item).length > 0 ? `
                            <h4 style="font-size: 12px; font-weight: bold; margin-top: 8px; margin-bottom: 3px; color: #004c99;">×”×—×–×¨×•×ª:</h4>
                            <table class="pdf-table">
                                <thead>
                                    <tr>
                                        <th>×¤×¨×™×˜</th>
                                        <th>×›××•×ª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.formData.returns.filter(r=>r.item).map(r => `<tr><td>${r.item}</td><td>${r.qty}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        ` : ''}
                        
                        ${state.formData.notes ? `<h4 style="font-size: 12px; font-weight: bold; margin-top: 8px; margin-bottom: 3px; color: #004c99;">×”×¢×¨×•×ª × ×”×’:</h4><p style="border: 1px solid #cce7f5; padding: 5px; border-radius: 5px; font-size: 10px; background-color: rgba(255, 255, 255, 0.8);">${state.formData.notes}</p>` : ''}
                    </div>

                    <div class="pdf-stamp-box">
                        <h4 style="font-size: 12px; font-weight: bold; text-align: center; margin-bottom: 5px; color: #004c99;">×—×•×ª××ª ×“×™×’×™×˜×œ×™×ª</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; font-size: 9px;">
                            <div><strong class="pdf-data-label">×©× × ×”×’:</strong> <span class="pdf-data-value">${state.formData.driver || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div><strong class="pdf-data-label">×©× ×œ×§×•×—:</strong> <span class="pdf-data-value">${customerNameToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div style="grid-column: 1 / span 2;"><strong class="pdf-data-label">×›×ª×•×‘×ª:</strong> <span class="pdf-data-value">${customerAddressToDisplay || '×œ× ×¦×•×™×Ÿ'}</span></div>
                            <div style="grid-column: 1 / span 2;"><strong class="pdf-data-label">××™×§×•×:</strong> <span class="pdf-data-value">${locationDisplay}</span></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 15px;">
                        <h4 style="font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #004c99;">××™×©×•×¨ ×§×‘×œ×ª ×©×™×¨×•×ª / ×¡×—×•×¨×”</h4>
                        <p style="font-size: 10px; margin-bottom: 8px;">×× ×™ ×”×—"×, <strong class="pdf-data-value">${state.formData.receiverName || '×œ× ×¦×•×™×Ÿ'}</strong>, ×××©×¨ ×§×‘×œ×ª ×”×©×™×¨×•×ª/×”×¡×—×•×¨×”.</p>
                        <div class="pdf-signature-area">
                            ${state.formData.signature ? `<img src="${state.formData.signature}" style="max-width: 90%; max-height: 90%; object-fit: contain;">` : `<p style="font-size: 10px; color: #777;">××™×Ÿ ×—×ª×™××”</p>`}
                        </div>
                        <p style="font-size: 9px; margin-top: 3px; color: #555;"><strong class="pdf-data-label">×©× ×”×—×•×ª×:</strong> <span class="pdf-data-value">${state.formData.receiverName || '×œ× ×¦×•×™×Ÿ'}</span></p>
                        <p style="font-size: 9px; margin-top: 1px; color: #555;"><strong class="pdf-data-label">×©×¢×ª ×—×ª×™××”:</strong> <span class="pdf-data-value">${new Date().toLocaleTimeString('he-IL')}</span></p>
                        <p style="font-size: 9px; margin-top: 1px; color: #555;"><strong class="pdf-data-label">××™×§×•× ×—×ª×™××”:</strong> <span class="pdf-data-value">${locationDisplay}</span></p>
                    </div>
                    <div class="pdf-copyright">
                        <p>×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ 1994</p>
                    </div>
                `;
                
                pdfTemplate.innerHTML = pdfContentHtml; // Set the generated HTML to the temporary div

                // Capture the content as an image
                // Scale factor adjusted for A4 size and content density.
                // A higher scale means better quality, but also larger memory usage.
                // Adjust this value if content still overflows or quality is too low.
                const scaleFactor = 1.8; // Adjusted from 2 for better fit on A4 without overflow
                const pdfCanvas = await html2canvas(pdfTemplate, { 
                    scale: scaleFactor, 
                    useCORS: true, 
                    logging: false,
                    windowWidth: pdfTemplate.scrollWidth, // Ensure html2canvas captures full width
                    windowHeight: pdfTemplate.scrollHeight // Ensure html2canvas captures full height
                });

                document.body.removeChild(pdfTemplate); // Clean up the temporary div immediately

                const pdfDataURL = pdfCanvas.toDataURL('image/jpeg', 0.9); 

                // Add the captured image to jspdf
                const imgProps = pdf.getImageProperties(pdfDataURL);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                let currentY = 0;
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgRatio = imgProps.height / imgProps.width;

                // Split image into pages if too long
                let imgHeightRendered = pdfWidth * imgRatio;
                let heightLeft = imgHeightRendered;

                let position = 0;

                pdf.addImage(pdfDataURL, 'JPEG', 0, position, pdfWidth, imgHeightRendered);
                heightLeft -= pageHeight;

                while (heightLeft >= -10) { // Allow slight overlap to prevent gaps
                    position = heightLeft - imgHeightRendered;
                    pdf.addPage();
                    pdf.addImage(pdfDataURL, 'JPEG', 0, position, pdfWidth, imgHeightRendered);
                    heightLeft -= pageHeight;
                }
                
                // Add images to PDF on new pages
                if (state.formData.images.length > 0) {
                    state.formData.images.forEach((imgSrc, index) => {
                        pdf.addPage();
                        pdf.setFontSize(16);
                        pdf.text(`×ª××•× ×” ××¦×•×¨×¤×ª ${index + 1}`, pdfWidth / 2, 20, { align: 'center' });
                        const imgWidth = 150; // Fixed width for images
                        const imgHeight = (pdf.getImageProperties(imgSrc).height * imgWidth) / pdf.getImageProperties(imgSrc).width;
                        pdf.addImage(imgSrc, 'JPEG', (pdfWidth - imgWidth) / 2, 30, imgWidth, imgHeight);
                    });
                }
                
                const finalPdfData = pdf.output('datauristring'); // Get PDF as data URI string

                // Trigger PDF download
                pdf.save(`Saban_Report_${orderIdToDisplay || state.formData.serialNumber}.pdf`);

                // Prepare data for Apps Script
                const dataToSend = {
                    formData: state.formData,
                    pdfData: finalPdfData,
                    imageData: state.formData.images // Array of base64 image data
                };

                // Send data to Google Apps Script Web App
                console.log('Sending data to Apps Script URL:', appsScriptWebAppUrl); // Added for debugging
                try {
                    const response = await fetch(appsScriptWebAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend),
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showAppMessage('×”×˜×•×¤×¡ × ×©×œ×— ×‘×”×¦×œ×—×” ×œ××¢×¨×›×ª!', 'success');
                        document.getElementById('confirmation-modal').classList.remove('hidden');
                        document.getElementById('confirmation-modal').querySelector('.modal-content').classList.add('show');
                    } else {
                        showAppMessage(`×©×’×™××” ×‘×©×œ×™×—×”: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showAppMessage(`×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ${error.message}`, 'error');
                }
            }


            function setupEventListeners() {
                backBtn.addEventListener('click', () => handleNavigation('back'));
                nextBtn.addEventListener('click', () => handleNavigation('next'));
                submitBtn.addEventListener('click', handleSubmit);
                
                startNewOrderBtn.addEventListener('click', () => {
                    state.isNewOrderMode = true;
                    state.formData.orderId = null;
                    state.formData.customerName = null;
                    state.formData.customerAddress = null;
                    state.formData.items = [];
                    newOrderIdInput.value = '';
                    newCustomerNameInput.value = '';
                    newDeliveryDateInput.value = '';
                    newDeliveryTimeInput.value = '';
                    siteAccessSelect.value = '-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --';
                    orderDetailsContainer.classList.add('hidden');
                    updatePage();
                });

                backToExistingOrderBtn.addEventListener('click', () => {
                    state.isNewOrderMode = false;
                    state.formData.newOrderId = null;
                    state.formData.newCustomerName = null;
                    state.formData.newDeliveryDate = null;
                    state.formData.newDeliveryTime = null;
                    state.formData.siteAccessType = null;
                    updatePage();
                });


                driverSelect.addEventListener('change', (e) => {
                    const selectedDriver = MOCK_DATA.drivers.find(d => d.name === e.target.value);
                    if (selectedDriver) {
                        state.formData.driver = selectedDriver.name;
                        state.formData.vehicle = selectedDriver.vehicle;
                        populateOrders();
                        showAppMessage(`×©×œ×•× ${state.formData.driver}, ×‘×¨×•×š ×”×‘× ×œ××¢×¨×›×ª!`, 'info');
                    }
                });
                
                orderSelect.addEventListener('change', (e) => {
                    const selectedOrder = MOCK_DATA.orders.find(o => o.id === e.target.value);
                    if (selectedOrder) {
                        state.formData.orderId = selectedOrder.id;
                        state.formData.customerName = selectedOrder.customer;
                        state.formData.customerAddress = selectedOrder.address;
                        state.formData.items = selectedOrder.items;
                        
                        orderDetailsContainer.classList.remove('hidden');
                        document.getElementById('order-id-display').textContent = selectedOrder.id;
                        document.getElementById('order-date-display').textContent = new Date().toLocaleDateString('he-IL');
                        document.getElementById('customer-name-display').textContent = selectedOrder.customer;
                        document.getElementById('customer-address-display').textContent = selectedOrder.address;
                        
                        const tbody = document.getElementById('order-items-tbody');
                        tbody.innerHTML = '';
                        selectedOrder.items.forEach(item => {
                            tbody.innerHTML += `
                                <tr class="bg-white border-b">
                                    <td class="px-6 py-4">${item.sku}</td>
                                    <td class="px-6 py-4">${item.desc}</td>
                                    <td class="px-6 py-4">${item.qty}</td>
                                </tr>
                            `;
                        });
                        showAppMessage(`×”×–×× ×” ××¡×¤×¨ ${state.formData.orderId} × ×˜×¢× ×” ×‘×”×¦×œ×—×”.`, 'success');
                    }
                });
                
                document.getElementById('crane-work-type-group').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const value = e.target.dataset.value;
                        state.formData.craneWorkType = value;
                        
                        document.querySelectorAll('#crane-work-type-group button').forEach(btn => btn.classList.remove('btn-choice-active'));
                        e.target.classList.add('btn-choice-active');
                        
                        if (value === '×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨') {
                            document.getElementById('transfer-modal').classList.remove('hidden');
                            document.getElementById('transfer-modal').querySelector('.modal-content').classList.add('show');
                        }
                    }
                });

                document.getElementById('add-return-item-btn').addEventListener('click', addReturnItem);
                
                document.getElementById('clear-signature-btn').addEventListener('click', () => signaturePad.clear());
                
                document.getElementById('open-camera-btn').addEventListener('click', () => document.getElementById('camera-input').click());
                
                document.getElementById('camera-input').addEventListener('change', (event) => {
                    if (event.target.files && event.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            state.formData.images.push(e.target.result);
                            const previewContainer = document.getElementById('image-previews');
                            const imgWrapper = document.createElement('div');
                            imgWrapper.className = 'relative';
                            imgWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg shadow"><button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center font-bold">X</button>`;
                            previewContainer.appendChild(imgWrapper);
                            
                            imgWrapper.querySelector('button').onclick = () => {
                                state.formData.images = state.formData.images.filter(img => img !== e.target.result);
                                imgWrapper.remove();
                            };
                        };
                        reader.readAsDataURL(event.target.files[0]);
                    }
                });
                
                document.getElementById('confirm-transfer-btn').addEventListener('click', () => {
                    state.formData.transferFrom = document.getElementById('transfer-from').value;
                    state.formData.transferTo = document.getElementById('transfer-to').value;
                    document.getElementById('transfer-modal').classList.add('hidden');
                    document.getElementById('transfer-modal').querySelector('.modal-content').classList.remove('show');
                });
                document.getElementById('cancel-transfer-btn').addEventListener('click', () => {
                    document.getElementById('transfer-modal').classList.add('hidden');
                    document.getElementById('transfer-modal').querySelector('.modal-content').classList.remove('show');
                });
                 document.getElementById('close-confirmation-btn').addEventListener('click', () => {
                    document.getElementById('confirmation-modal').classList.add('hidden');
                    document.getElementById('confirmation-modal').querySelector('.modal-content').classList.remove('show');
                    window.location.reload();
                });

                // Event listeners for time inputs to trigger calculation and performance check
                document.getElementById('wait-start-time').addEventListener('input', () => { calculateAndDisplayTimes(); checkDriverPerformance(); });
                document.getElementById('wait-end-time').addEventListener('input', () => { calculateAndDisplayTimes(); checkDriverPerformance(); });
                document.getElementById('crane-start-time').addEventListener('input', () => { calculateAndDisplayTimes(); checkDriverPerformance(); });
                document.getElementById('crane-end-time').addEventListener('input', () => { calculateAndDisplayTimes(); checkDriverPerformance(); });

                // WhatsApp buttons for dispatch
                document.getElementById('whatsapp-complete-btn').addEventListener('click', () => {
                    const driverName = state.formData.driver || '×”× ×”×’';
                    sendWhatsAppMessage(`${driverName} ×¡×™×™× ××ª ×”×¤×¢×•×œ×” ×©×œ×• ×•××•×›×Ÿ ×œ××©×™××” ×”×‘××”.`);
                    showAppMessage('×”×•×“×¢×ª ×¡×™×•× ×¤×¢×•×œ×” × ×©×œ×—×” ×œ××—×œ×§×ª ×¡×™×“×•×¨.', 'success');
                });

                document.getElementById('whatsapp-delay-btn').addEventListener('click', () => {
                    const driverName = state.formData.driver || '×”× ×”×’';
                    const orderId = state.formData.orderId || state.formData.newOrderId || '×œ× ×¦×•×™×Ÿ';
                    const totalWaitMinutes = state.formData.totalWaitMinutes || 0;
                    sendWhatsAppMessage(`×¢×™×›×•×‘ ×‘×”×–×× ×” ${orderId} ×¢×‘×•×¨ ${driverName}. ×–××Ÿ ×”××ª× ×”: ${totalWaitMinutes} ×“×§×•×ª. ×× × ×‘×“×•×§.`);
                    showAppMessage('×”×•×“×¢×ª ×¢×™×›×•×‘ × ×©×œ×—×” ×œ××—×œ×§×ª ×¡×™×“×•×¨.', 'info');
                });

                document.getElementById('whatsapp-issue-btn').addEventListener('click', () => {
                    const driverName = state.formData.driver || '×”× ×”×’';
                    const orderId = state.formData.orderId || state.formData.newOrderId || '×œ× ×¦×•×™×Ÿ';
                    const issueNotes = prompt('×× × ×¤×¨×˜ ××ª ×”×‘×¢×™×”:'); // Using prompt for simplicity, ideally a custom modal
                    if (issueNotes) {
                        sendWhatsAppMessage(`×‘×¢×™×” ×‘×”×–×× ×” ${orderId} ×¢×‘×•×¨ ${driverName}: ${issueNotes}. ×× × ×‘×“×•×§.`);
                        showAppMessage('×”×•×“×¢×ª ×‘×¢×™×” × ×©×œ×—×” ×œ××—×œ×§×ª ×¡×™×“×•×¨.', 'error');
                    } else {
                        showAppMessage('×“×™×•×•×— ×”×‘×¢×™×” ×‘×•×˜×œ.', 'info');
                    }
                });
            }

            window.addEventListener('resize', () => {
                const canvas = document.getElementById('signature-pad');
                if (canvas && signaturePad) {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear();
                }
            });
            window.dispatchEvent(new Event('resize'));
            
            initialize();
        });
    </script>
</body>
</html>
