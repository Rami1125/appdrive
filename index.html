<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×˜×•×¤×¡ ×ª×™×¢×•×“ ×¢×‘×•×“×” - ×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Bright Blue, White, and Subtle Grays -->
    <!-- Application Structure Plan: The application is designed as a multi-step wizard (3 pages) to guide the driver through the documentation process logically. This structure mimics the natural workflow of a delivery: 1. Confirm Order, 2. Log Field Events, 3. Get Client Approval. This sequential flow minimizes cognitive load and ensures all necessary data is captured before submission. A progress bar provides clear visual feedback on completion status. The user flow is designed for mobile-first usability with large, touch-friendly controls. The first page now supports both selecting an existing order and initiating a new one, providing flexibility for different operational scenarios. -->
    <!-- Visualization & Content Choices: The application uses structured HTML forms styled with Tailwind CSS for a clean, modern interface. Interactive elements like dropdowns for driver/order selection, dynamic addition of return items, and a modal for transfer details streamline data entry. The "Start New Order" button dynamically reveals new input fields for manual order creation. For the client signature, a canvas element with the SignaturePad.js library provides a smooth signing experience. Finally, jsPDF and html2canvas are used to generate a professional PDF report on the client-side, mirroring a formal document. This approach avoids server-side dependencies for PDF generation, making the single-page application self-contained. The design now incorporates glassmorphism for a premium feel, enhanced button animations, and a responsive table with hover effects for better user interaction. Location tracking is added to capture driver's coordinates at the time of submission. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f0f8ff; /* A lighter blue-ish white */ }
        .form-section {
            background: rgba(255, 255, 255, 0.4); /* More transparent white */
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Stronger, bluer shadow */
            backdrop-filter: blur(10px); /* Glassmorphism blur */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18); /* Subtle white border */
            transition: all 0.5s ease-in-out; /* Smooth entrance */
            transform: translateY(20px);
            opacity: 0;
        }
        .form-section.active-page {
            transform: translateY(0);
            opacity: 1;
        }
        .progress-step { transition: all 0.3s ease; }
        .progress-step-active { background-color: #007bff; /* Bright Blue */ color: white; }
        .progress-step-inactive { background-color: #e0e7ff; /* Lighter blue */ }
        .progress-line { background-color: #e0e7ff; height: 4px; transition: all 0.3s ease; }
        .btn-primary { 
            background-color: #007bff; /* Bright Blue */ 
            color: white; 
            transition: all 0.2s ease-in-out; 
            transform: scale(1);
            box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2); /* Subtle glow */
        }
        .btn-primary:hover { 
            background-color: #0056b3; /* Darker blue on hover */ 
            transform: scale(1.05); /* Smart button upgrade */
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.3);
        }
        .btn-primary:active {
            transform: scale(0.95); /* Click animation */
        }
        .btn-secondary { 
            background-color: #6c757d; 
            color: white; 
            transition: all 0.2s ease-in-out; 
            transform: scale(1);
            box-shadow: 0 4px 6px rgba(108, 117, 125, 0.2);
        }
        .btn-secondary:hover { 
            background-color: #5a6268; 
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.3);
        }
        .btn-secondary:active {
            transform: scale(0.95);
        }
        .btn-choice { 
            background-color: rgba(255, 255, 255, 0.6); 
            border: 1px solid rgba(0, 123, 255, 0.2); /* Subtle blue border */
            transition: all 0.2s ease-in-out; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-choice:hover {
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-choice-active { 
            background-color: #e0f0ff; /* Lighter blue background */
            border-color: #007bff; /* Bright blue border */
            color: #0056b3; 
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4); /* Glow effect */
        }
        .signature-pad-container {
            background: rgba(255, 255, 255, 0.5); /* Semi-transparent white */
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(0, 0, 0, 0.2); /* Inner shadow for depth */
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); } /* Darker backdrop for modals */
        .modal-content {
            background: rgba(255, 255, 255, 0.8); /* Semi-transparent white */
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-out;
        }
        .modal-content.show {
            transform: scale(1);
            opacity: 1;
        }
        /* Responsive Table Styling */
        .responsive-table th, .responsive-table td {
            padding: 12px 24px;
            text-align: right;
            border-bottom: 1px solid #e0e7ff; /* Light blue border */
        }
        .responsive-table th {
            background-color: #e0f0ff; /* Light blue header */
            font-weight: 600;
            color: #0056b3;
            text-transform: uppercase;
        }
        .responsive-table tbody tr:hover {
            background-color: #f0f8ff; /* Very light blue on hover */
            transition: background-color 0.2s ease-in-out;
        }
        .responsive-table tbody tr:last-child td {
            border-bottom: none;
        }
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app" class="container mx-auto max-w-2xl p-4 min-h-screen">
        <header class="text-center mb-6">
            <img src="https://placehold.co/128x128/007bff/ffffff?text=SABAN" alt="×œ×•×’×• ×—. ×¡×‘×Ÿ" class="w-32 h-32 object-contain mx-auto mb-4 rounded-full shadow-lg">
            <h1 class="text-3xl font-bold text-slate-800">×˜×•×¤×¡ ×ª×™×¢×•×“ ×¢×‘×•×“×” ×“×™×’×™×˜×œ×™</h1>
            <p class="text-slate-600">×—. ×¡×‘×Ÿ - ×—×•××¨×™ ×‘× ×™×Ÿ 1994 ×‘×¢"×</p>
        </header>

        <div id="progress-bar" class="w-full mb-8">
            <div class="flex items-center justify-between">
                <div id="step-1" class="progress-step progress-step-active w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">1</div>
                <div class="progress-line flex-1"></div>
                <div id="step-2" class="progress-step progress-step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">2</div>
                <div class="progress-line flex-1"></div>
                <div id="step-3" class="progress-step progress-step-inactive w-10 h-10 rounded-full flex items-center justify-center font-bold z-10">3</div>
            </div>
        </div>

        <main>
            <!-- Page 1: Order Details -->
            <div id="page-1" class="form-section p-6 space-y-6">
                <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 1: ×¤×¨×˜×™ ×”×–×× ×”</h2>
                
                <div id="existing-order-section">
                    <div>
                        <label for="driver-select" class="block mb-2 text-sm font-medium text-slate-700">×‘×—×¨ × ×”×’/×¨×›×‘:</label>
                        <select id="driver-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500">
                            <option selected disabled>-- ×‘×—×¨ ×©× --</option>
                        </select>
                    </div>
                    <div>
                        <label for="order-select" class="block mb-2 text-sm font-medium text-slate-700">×‘×—×¨ ××¡×¤×¨ ×”×–×× ×”:</label>
                        <select id="order-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500" disabled>
                            <option selected disabled>-- ×‘×—×¨ ×”×–×× ×” --</option>
                        </select>
                    </div>
                    <div id="order-details-container" class="hidden space-y-4 pt-4 border-t">
                        <h3 class="text-lg font-semibold text-slate-700">×¡×™×›×•× ×¤×¨×˜×™ ×”×–×× ×”</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><strong class="font-semibold text-slate-600">××¡×¤×¨ ×”×–×× ×”:</strong> <span id="order-id-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×ª××¨×™×š:</strong> <span id="order-date-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×©× ×œ×§×•×—:</strong> <span id="customer-name-display"></span></div>
                            <div><strong class="font-semibold text-slate-600">×›×ª×•×‘×ª:</strong> <span id="customer-address-display"></span></div>
                        </div>
                        <!-- Responsive Table Template for Order Items (re-added for styling demonstration) -->
                        <div class="mt-4">
                            <strong class="font-semibold text-slate-600">×¤×™×¨×•×˜ ×¤×¨×™×˜×™×:</strong>
                            <div class="mt-2 rounded-lg overflow-hidden shadow-sm">
                                <table class="responsive-table w-full text-sm text-right text-slate-600">
                                    <thead class="text-xs text-slate-700 uppercase">
                                        <tr>
                                            <th scope="col">××§"×˜</th>
                                            <th scope="col">×ª×™××•×¨</th>
                                            <th scope="col">×›××•×ª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="order-items-tbody">
                                        <!-- Items will be populated here by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center my-4">
                    <span class="text-slate-500">××•</span>
                </div>

                <button type="button" id="start-new-order-btn" class="btn-primary px-4 py-2 rounded-lg font-semibold w-full">×”×ª×—×œ ×”×–×× ×” ×—×“×©×”</button>

                <div id="new-order-section" class="hidden space-y-4 pt-4 border-t">
                    <h3 class="text-lg font-semibold text-slate-700">×¤×¨×˜×™ ×”×–×× ×” ×—×“×©×”</h3>
                    <div>
                        <label for="new-order-id-input" class="block mb-2 text-sm font-medium text-slate-700">××¡×¤×¨ ×”×–×× ×”:</label>
                        <input type="text" id="new-order-id-input" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×–×Ÿ ××¡×¤×¨ ×”×–×× ×”">
                    </div>
                    <div>
                        <label for="new-customer-name-input" class="block mb-2 text-sm font-medium text-slate-700">×©× ×œ×§×•×—:</label>
                        <input type="text" id="new-customer-name-input" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×–×Ÿ ×©× ×œ×§×•×—">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-delivery-date-input" class="block mb-2 text-sm font-medium text-slate-700">×ª××¨×™×š ××¡×¤×§×”:</label>
                            <input type="date" id="new-delivery-date-input" class="w-full p-2.5 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-delivery-time-input" class="block mb-2 text-sm font-medium text-slate-700">×©×¢×ª ××¡×¤×§×”:</label>
                            <input type="time" id="new-delivery-time-input" class="w-full p-2.5 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="site-access-select" class="block mb-2 text-sm font-medium text-slate-700">×’×™×©×” ×œ××ª×¨:</label>
                        <select id="site-access-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-slate-50 focus:ring-blue-500 focus:border-blue-500">
                            <option selected disabled>-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --</option>
                            <option value="×¢×‘×•×“×ª ×× ×•×£">×¢×‘×•×“×ª ×× ×•×£</option>
                            <option value="×”×¢×‘×¨×ª ×¦×™×•×“">×”×¢×‘×¨×ª ×¦×™×•×“</option>
                            <option value="××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª">××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª</option>
                        </select>
                    </div>
                    <button type="button" id="back-to-existing-order-btn" class="btn-secondary px-4 py-2 rounded-lg font-semibold w-full">×—×–×•×¨ ×œ×‘×—×™×¨×ª ×”×–×× ×” ×§×™×™××ª</button>
                </div>
            </div>

            <!-- Page 2: Field Log -->
            <div id="page-2" class="hidden form-section p-6 space-y-6">
                <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 2: ×ª×™×¢×•×“ ××™×¨×•×¢×™× ×‘×©×˜×—</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="wait-start-time" class="block mb-2 text-sm font-medium text-slate-700">×ª×—×™×œ×ª ×”××ª× ×”:</label>
                        <input type="time" id="wait-start-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="wait-end-time" class="block mb-2 text-sm font-medium text-slate-700">×¡×™×•× ×”××ª× ×”:</label>
                        <input type="time" id="wait-end-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="crane-start-time" class="block mb-2 text-sm font-medium text-slate-700">×ª×—×™×œ×ª ×¢×‘×•×“×ª ×× ×•×£:</label>
                        <input type="time" id="crane-start-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="crane-end-time" class="block mb-2 text-sm font-medium text-slate-700">×¡×™×•× ×¢×‘×•×“×ª ×× ×•×£:</label>
                        <input type="time" id="crane-end-time" class="w-full p-2.5 border border-slate-300 rounded-lg">
                    </div>
                </div>

                <div>
                    <label class="block mb-2 text-sm font-medium text-slate-700">×¡×•×’ ×¢×‘×•×“×ª ×× ×•×£:</label>
                    <div id="crane-work-type-group" class="flex flex-wrap gap-3">
                        <button type="button" data-value="×¢×‘×•×“×” ×‘××ª×¨ ×”×œ×§×•×—" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸ—ï¸ ×¢×‘×•×“×” ×‘××ª×¨ ×”×œ×§×•×—</button>
                        <button type="button" data-value="×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸšš ×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨</button>
                        <button type="button" data-value="××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª" class="btn-choice px-4 py-2 rounded-lg text-sm">ğŸ—‘ï¸ ××™×¡×•×£ ×©×§ ×¤×¡×•×œ×ª</button>
                    </div>
                </div>
                
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">×”×—×–×¨×•×ª ××œ×§×•×—:</h3>
                    <div id="returns-container" class="space-y-3"></div>
                    <button type="button" id="add-return-item-btn" class="mt-2 text-sm text-blue-600 font-semibold hover:text-blue-800">+ ×”×•×¡×£ ×¤×¨×™×˜ ×œ×”×—×–×¨×”</button>
                </div>
                
                <div class="border-t pt-4">
                     <h3 class="text-lg font-semibold text-slate-700 mb-2">×”×¢×¨×•×ª ×•×¦×™×œ×•××™×:</h3>
                    <textarea id="driver-notes" rows="3" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×›×ª×•×‘ ×›××Ÿ ×”×¢×¨×•×ª ×—×•×¤×©×™×•×ª..."></textarea>
                    <button type="button" id="open-camera-btn" class="mt-2 inline-flex items-center gap-2 btn-secondary px-4 py-2 rounded-lg text-sm">
                        ğŸ“¸ ×¦×¨×£ ×ª××•× ×”
                    </button>
                    <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden">
                    <div id="image-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2"></div>
                </div>
            </div>

            <!-- Page 3: Signature & Finish -->
            <div id="page-3" class="hidden form-section p-6 space-y-6">
                 <h2 class="text-2xl font-semibold text-slate-700 border-b pb-2">×©×œ×‘ 3: ××™×©×•×¨ ×•×¡×™×•×</h2>
                <div>
                    <label for="receiver-name" class="block mb-2 text-sm font-medium text-slate-700">×©× ××§×‘×œ ×”×¡×—×•×¨×” / ××™×© ×§×©×¨:</label>
                    <input type="text" id="receiver-name" class="w-full p-2.5 border border-slate-300 rounded-lg" placeholder="×”×§×œ×“ ××ª ×©× ×”××§×‘×œ">
                </div>
                <div>
                    <label class="block mb-2 text-sm font-medium text-slate-700">×—×ª×™××ª ×œ×§×•×—:</label>
                    <div class="w-full h-48 md:h-64 rounded-lg signature-pad-container shadow-inner p-2">
                        <canvas id="signature-pad" class="w-full h-full bg-white/70 rounded"></canvas>
                    </div>
                    <button type="button" id="clear-signature-btn" class="mt-2 text-sm text-red-600 font-semibold hover:text-red-800">× ×§×” ×—×ª×™××”</button>
                </div>
            </div>

            <!-- Navigation -->
            <div id="navigation-controls" class="mt-8 flex justify-between items-center">
                <button type="button" id="back-btn" class="btn-secondary px-6 py-2 rounded-lg font-semibold" disabled>×—×–×¨×”</button>
                <button type="button" id="next-btn" class="btn-primary px-6 py-2 rounded-lg font-semibold">×”×‘×</button>
                <button type="button" id="submit-btn" class="hidden btn-primary bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-bold">×©×œ×— ×•×¡×™×™×</button>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="transfer-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 modal-content">
            <h3 class="text-xl font-semibold">×¤×¨×˜×™ ×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨</h3>
            <div>
                <label for="transfer-from" class="block mb-2 text-sm font-medium text-slate-700">×”×¢×‘×¨×” ×××ª×¨ (×›×ª×•×‘×ª × ×•×›×—×™×ª):</label>
                <input type="text" id="transfer-from" class="w-full p-2.5 border border-slate-300 rounded-lg">
            </div>
            <div>
                <label for="transfer-to" class="block mb-2 text-sm font-medium text-slate-700">××œ ××ª×¨ (×›×ª×•×‘×ª ×™×¢×“):</label>
                <input type="text" id="transfer-to" class="w-full p-2.5 border border-slate-300 rounded-lg">
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-transfer-btn" type="button" class="btn-secondary px-4 py-2 rounded-lg text-sm">×‘×™×˜×•×œ</button>
                <button id="confirm-transfer-btn" type="button" class="btn-primary px-4 py-2 rounded-lg text-sm">××™×©×•×¨</button>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 z-50 modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center space-y-4 modal-content">
             <div class="text-6xl">âœ…</div>
            <h3 class="text-2xl font-bold">×”×˜×•×¤×¡ × ×©×œ×— ×‘×”×¦×œ×—×”!</h3>
            <p class="text-slate-600">×§×•×‘×¥ PDF × ×•×¦×¨ ×•× ×©××¨. ×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘××¢×¨×›×ª. × ×™×ª×Ÿ ×œ×¡×’×•×¨ ××ª ×”×—×œ×•×Ÿ.</p>
            <div class="pt-4">
                 <button id="close-confirmation-btn" type="button" class="btn-primary w-full px-6 py-2 rounded-lg font-semibold">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Display -->
    <div id="app-message" class="fixed top-4 left-1/2 -translate-x-1/2 bg-blue-100 text-blue-800 p-3 rounded-lg shadow-md z-50 hidden transition-opacity duration-300" role="alert">
        <p id="app-message-text" class="font-semibold text-center"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const MOCK_DATA = {
                drivers: [
                    { name: '×©××•×œ', vehicle: '61541002' },
                    { name: '×—×›××ª', vehicle: '61541002' },
                    { name: '×¤××œ×— ×”×•×‘×œ×•×ª ×¢×•×‘×™×™×“×”', vehicle: '97-405-86' },
                    { name: '×¢×œ××', vehicle: '' },
                    { name: '×™×•××‘', vehicle: '47818801' },
                    { name: '×¢×œ×™', vehicle: '65151701' },
                    { name: '××•×¡×™×™×“', vehicle: '63-511-31' },
                    { name: '× ×™×¡×™× ××’×™×“×™×©', vehicle: '' },
                ],
                orders: [
                    { id: '6207015', customer: '×™×©×¨××œ ×™×©×¨××œ×™', address: '×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ', items: [{sku: '101', desc: '××©×˜×— ×‘×œ×•×§×™×', qty: 2}, {sku: '205', desc: '×©×§ ××œ×˜', qty: 10}] },
                    { id: '6207018', customer: '××©×” ×›×”×Ÿ', address: '×–×‘×•×˜×™× ×¡×§×™ 15, ×ª×œ ××‘×™×‘', items: [{sku: '310', desc: '×—×‘×™×ª ×¤×§×“×•×Ÿ', qty: 1}, {sku: '402', desc: '××©×˜×— ×¡×‘×Ÿ', qty: 3}] },
                    { id: '6207021', customer: '×“×•×“ ×œ×•×™', address: '×”× ×©×™× 1, ×¨×¢× × ×”', items: [{sku: '101', desc: '××©×˜×— ×‘×œ×•×§×™×', qty: 5}] }
                ],
                returnableItems: ["×©×§ ×¤×§×“×•×Ÿ", "××©×˜×— ×¡×‘×Ÿ", "××©×˜×— ×‘×œ×•×§×™×", "×—×‘×™×ª ×¤×§×“×•×Ÿ", "×©×§ ×¤×¡×•×œ×ª"]
            };

            const state = {
                currentPage: 1,
                isNewOrderMode: false,
                formData: {
                    driver: null,
                    vehicle: null,
                    orderId: null,
                    customerName: null,
                    customerAddress: null,
                    items: [], 
                    
                    newOrderId: null,
                    newCustomerName: null,
                    newDeliveryDate: null,
                    newDeliveryTime: null,
                    siteAccessType: null,

                    waitStartTime: null,
                    waitEndTime: null,
                    craneStartTime: null,
                    craneEndTime: null,
                    craneWorkType: null,
                    transferFrom: null,
                    transferTo: null,
                    returns: [],
                    notes: '',
                    images: [],
                    receiverName: null,
                    signature: null,
                    location: null, // Will store {lat, lon, timestamp}
                    serialNumber: `SBN-${Date.now()}`
                }
            };

            const pages = [document.getElementById('page-1'), document.getElementById('page-2'), document.getElementById('page-3')];
            const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            const driverSelect = document.getElementById('driver-select');
            const orderSelect = document.getElementById('order-select');
            const existingOrderSection = document.getElementById('existing-order-section');
            const startNewOrderBtn = document.getElementById('start-new-order-btn');
            const newOrderSection = document.getElementById('new-order-section');
            const backToExistingOrderBtn = document.getElementById('back-to-existing-order-btn');

            const newOrderIdInput = document.getElementById('new-order-id-input');
            const newCustomerNameInput = document.getElementById('new-customer-name-input');
            const newDeliveryDateInput = document.getElementById('new-delivery-date-input');
            const newDeliveryTimeInput = document.getElementById('new-delivery-time-input');
            const siteAccessSelect = document.getElementById('site-access-select');
            const orderDetailsContainer = document.getElementById('order-details-container');


            let signaturePad = null;

            function initialize() {
                populateDrivers();
                setupEventListeners();
                parseUrlParams(); // Check for orderId/driverName in URL
                updatePage();
                requestLocation(); // Initial location request
            }

            function parseUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const orderIdParam = params.get('orderId');
                const driverNameParam = params.get('driverName');

                if (orderIdParam && driverNameParam) {
                    state.formData.orderId = orderIdParam;
                    state.formData.driver = driverNameParam;

                    // Try to find the driver in MOCK_DATA
                    const selectedDriver = MOCK_DATA.drivers.find(d => d.name === driverNameParam);
                    if (selectedDriver) {
                        state.formData.vehicle = selectedDriver.vehicle;
                        driverSelect.value = selectedDriver.name; // Set dropdown
                        populateOrders();
                        // Find and select the order
                        const selectedOrder = MOCK_DATA.orders.find(o => o.id === orderIdParam);
                        if (selectedOrder) {
                            orderSelect.value = selectedOrder.id; // Set dropdown
                            state.formData.customerName = selectedOrder.customer;
                            state.formData.customerAddress = selectedOrder.address;
                            state.formData.items = selectedOrder.items;

                            document.getElementById('order-details-container').classList.remove('hidden');
                            document.getElementById('order-id-display').textContent = selectedOrder.id;
                            document.getElementById('order-date-display').textContent = new Date().toLocaleDateString('he-IL');
                            document.getElementById('customer-name-display').textContent = selectedOrder.customer;
                            document.getElementById('customer-address-display').textContent = selectedOrder.address;
                            
                            const tbody = document.getElementById('order-items-tbody');
                            tbody.innerHTML = '';
                            selectedOrder.items.forEach(item => {
                                tbody.innerHTML += `
                                    <tr class="bg-white border-b">
                                        <td class="px-6 py-4">${item.sku}</td>
                                        <td class="px-6 py-4">${item.desc}</td>
                                        <td class="px-6 py-4">${item.qty}</td>
                                    </tr>
                                `;
                            });
                            showAppMessage(`×”×–×× ×” ××¡×¤×¨ ${state.formData.orderId} × ×˜×¢× ×” ××•×˜×•××˜×™×ª ×¢×‘×•×¨ ${state.formData.driver}.`, 'success');
                        } else {
                            showAppMessage('××¡×¤×¨ ×”×–×× ×” ×œ× × ××¦× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ ×”×–×× ×” ×™×“× ×™×ª.', 'error');
                        }
                    } else {
                        showAppMessage('×©× ×”× ×”×’ ×œ× × ××¦× ×‘××¢×¨×›×ª. ×× × ×‘×—×¨ × ×”×’ ×™×“× ×™×ª.', 'error');
                    }
                }
            }

            function populateDrivers() {
                MOCK_DATA.drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.name;
                    option.textContent = `${driver.name}${driver.vehicle ? ` (${driver.vehicle})` : ''}`;
                    driverSelect.appendChild(option);
                });
            }

            function populateOrders() {
                orderSelect.innerHTML = '<option selected disabled>-- ×‘×—×¨ ×”×–×× ×” --</option>';
                MOCK_DATA.orders.forEach(order => {
                     const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `×”×–×× ×” ${order.id} - ${order.customer}`;
                    orderSelect.appendChild(option);
                });
                orderSelect.disabled = false;
            }

            function updatePage() {
                pages.forEach((page, index) => {
                    const isCurrentPage = index + 1 === state.currentPage;
                    page.classList.toggle('hidden', !isCurrentPage);
                    page.classList.toggle('active-page', isCurrentPage);
                    if (isCurrentPage && page.id === 'page-3') {
                        setTimeout(() => {
                            const canvas = document.getElementById('signature-pad');
                            if (!signaturePad) {
                                signaturePad = new SignaturePad(canvas);
                            }
                            const ratio = Math.max(window.devicePixelRatio || 1, 1);
                            canvas.width = canvas.offsetWidth * ratio;
                            canvas.height = canvas.offsetHeight * ratio;
                            canvas.getContext("2d").scale(ratio, ratio);
                            signaturePad.clear();
                            if (state.formData.signature) {
                                signaturePad.fromDataURL(state.formData.signature);
                            }
                        }, 100);
                    }
                });
                steps.forEach((step, index) => {
                    step.classList.toggle('progress-step-active', index < state.currentPage);
                    step.classList.toggle('progress-step-inactive', index >= state.currentPage);
                });

                backBtn.disabled = state.currentPage === 1;
                nextBtn.classList.toggle('hidden', state.currentPage === 3);
                submitBtn.classList.toggle('hidden', state.currentPage !== 3);

                if (state.currentPage === 1) {
                    existingOrderSection.classList.toggle('hidden', state.isNewOrderMode);
                    startNewOrderBtn.classList.toggle('hidden', state.isNewOrderMode);
                    newOrderSection.classList.toggle('hidden', !state.isNewOrderMode);
                }


                if (state.currentPage === 1 && state.formData.driver) {
                    showAppMessage(`×‘×¨×•×š ×”×‘×, ${state.formData.driver}! ×× × ×‘×—×¨ ×”×–×× ×” ××• ×”×ª×—×œ ×—×“×©×”.`, 'info');
                } else if (state.currentPage === 2 && state.formData.driver) {
                    const progressPercentage = Math.floor((state.currentPage / pages.length) * 100);
                    showAppMessage(`×›×œ ×”×›×‘×•×“ ${state.formData.driver}, ×¢×‘×¨×ª ${progressPercentage}% ××”×˜×•×¤×¡!`, 'success');
                    if (document.getElementById('crane-start-time').value === '' || document.getElementById('crane-end-time').value === '') {
                        showAppMessage(` ${state.formData.driver}, ×× × ×ª×¢×“ ×©×¢×•×ª ×‘××“×•×™×§.`, 'info');
                    }
                } else if (state.currentPage === 3 && state.formData.driver) {
                     showAppMessage(`×›××¢×˜ ×¡×™×™××ª, ${state.formData.driver}! ×× × ×§×‘×œ ×—×ª×™××” ××”×œ×§×•×—.`, 'info');
                }
            }
            
            function showAppMessage(message, type = 'info') {
                const messageDiv = document.getElementById('app-message');
                const messageText = document.getElementById('app-message-text');
                messageText.textContent = message;

                messageDiv.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-md z-50 transition-opacity duration-300';
                if (type === 'success') {
                    messageDiv.classList.add('bg-green-100', 'text-green-800');
                } else if (type === 'error') {
                    messageDiv.classList.add('bg-red-100', 'text-red-800');
                } else {
                    messageDiv.classList.add('bg-blue-100', 'text-blue-800');
                }

                messageDiv.classList.remove('hidden');
                messageDiv.style.opacity = '1';

                setTimeout(() => {
                    messageDiv.style.opacity = '0';
                    setTimeout(() => messageDiv.classList.add('hidden'), 300);
                }, 5000);
            }

            function saveFormData() {
                state.formData.waitStartTime = document.getElementById('wait-start-time').value;
                state.formData.waitEndTime = document.getElementById('wait-end-time').value;
                state.formData.craneStartTime = document.getElementById('crane-start-time').value;
                state.formData.craneEndTime = document.getElementById('crane-end-time').value;
                state.formData.notes = document.getElementById('driver-notes').value;
                state.formData.receiverName = document.getElementById('receiver-name').value;
                
                if (signaturePad && !signaturePad.isEmpty()) {
                    state.formData.signature = signaturePad.toDataURL();
                } else {
                    state.formData.signature = null;
                }

                if (state.isNewOrderMode) {
                    state.formData.orderId = newOrderIdInput.value; // Use this for PDF naming
                    state.formData.customerName = newCustomerNameInput.value; // Use this for PDF
                    state.formData.newOrderId = newOrderIdInput.value;
                    state.formData.newCustomerName = newCustomerNameInput.value;
                    state.formData.newDeliveryDate = newDeliveryDateInput.value;
                    state.formData.newDeliveryTime = newDeliveryTimeInput.value;
                    state.formData.siteAccessType = siteAccessSelect.value;
                }
            }
            
            function handleNavigation(direction) {
                 if (direction === 'next' && state.currentPage < 3) {
                     if(validatePage()) {
                        saveFormData();
                        state.currentPage++;
                     }
                } else if (direction === 'back' && state.currentPage > 1) {
                    saveFormData();
                    state.currentPage--;
                }
                updatePage();
            }
            
            function validatePage() {
                if(state.currentPage === 1) {
                    if (state.isNewOrderMode) {
                        if (!newOrderIdInput.value.trim() || !newCustomerNameInput.value.trim() || !newDeliveryDateInput.value || !newDeliveryTimeInput.value || siteAccessSelect.value === '-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --') {
                            showAppMessage('×× × ××œ× ××ª ×›×œ ×¤×¨×˜×™ ×”×”×–×× ×” ×”×—×“×©×”.', 'error');
                            return false;
                        }
                    } else {
                        if(!state.formData.orderId) {
                            showAppMessage('×™×© ×œ×‘×—×•×¨ ×”×–×× ×” ×œ×¤× ×™ ×”××¢×‘×¨ ×œ×©×œ×‘ ×”×‘×.', 'error');
                            return false;
                        }
                    }
                }
                if(state.currentPage === 3) {
                     if(document.getElementById('receiver-name').value.trim() === '') {
                        showAppMessage('×™×© ×œ×”×–×™×Ÿ ××ª ×©× ××§×‘×œ ×”×¡×—×•×¨×”.', 'error');
                        return false;
                    }
                    if(signaturePad && signaturePad.isEmpty()) {
                        showAppMessage('×™×© ×œ×—×ª×•× ×œ×¤× ×™ ×”×©×œ×™×—×”.', 'error');
                        return false;
                    }
                }
                return true;
            }

            function addReturnItem() {
                const returnId = `return-${Date.now()}`;
                const container = document.createElement('div');
                container.id = returnId;
                container.className = 'flex items-center gap-2';

                const select = document.createElement('select');
                select.className = 'w-2/3 p-2 border border-slate-300 rounded-lg bg-slate-50 return-item-select';
                select.innerHTML = '<option disabled selected>×‘×—×¨ ×¤×¨×™×˜...</option>';
                MOCK_DATA.returnableItems.forEach(item => {
                    select.innerHTML += `<option value="${item}">${item}</option>`;
                });

                const input = document.createElement('input');
                input.type = 'number';
                input.min = 1;
                input.placeholder = '×›××•×ª';
                input.className = 'w-1/3 p-2 border border-slate-300 rounded-lg return-item-qty';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'âŒ';
                removeBtn.className = 'text-sm';
                removeBtn.onclick = () => {
                    document.getElementById(returnId).remove();
                    state.formData.returns = state.formData.returns.filter(r => r.id !== returnId);
                };
                
                container.append(select, input, removeBtn);
                document.getElementById('returns-container').appendChild(container);

                const returnObject = { id: returnId, item: '', qty: 0 };
                state.formData.returns.push(returnObject);
                select.onchange = (e) => returnObject.item = e.target.value;
                input.onchange = (e) => returnObject.qty = e.target.value;
            }

            function requestLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            state.formData.location = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                timestamp: new Date().toISOString()
                            };
                            showAppMessage(`××™×§×•× × ×”×’ ×ª×•×¢×“: ×§×• ×¨×•×—×‘ ${position.coords.latitude.toFixed(4)}, ×§×• ××•×¨×š ${position.coords.longitude.toFixed(4)}`, 'success');
                        },
                        (error) => { 
                            state.formData.location = "Unavailable";
                            showAppMessage(`×©×’×™××ª ××™×§×•×: ${error.message}. ×× × ×•×•×“× ×©×”×¨×©××ª ××™×§×•× ××•×¤×¢×œ×ª.`, 'error');
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                     state.formData.location = "Not supported";
                     showAppMessage('×©×™×¨×•×ª×™ ××™×§×•× ××™× × × ×ª××›×™× ×‘×“×¤×“×¤×Ÿ ×–×”.', 'error');
                }
            }
            
            async function handleSubmit() {
                if (!validatePage()) return;
                saveFormData();
                
                // Re-request location just before submission for accuracy
                requestLocation(); 
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pdfTemplate = document.createElement('div');
                pdfTemplate.style.width = '210mm';
                pdfTemplate.style.padding = '15mm';
                pdfTemplate.style.fontFamily = 'Assistant, sans-serif';
                pdfTemplate.style.direction = 'rtl';

                const orderIdToDisplay = state.isNewOrderMode ? state.formData.newOrderId : state.formData.orderId;
                const customerNameToDisplay = state.isNewOrderMode ? state.formData.newCustomerName : state.formData.customerName;
                const deliveryDateToDisplay = state.isNewOrderMode ? new Date(state.formData.newDeliveryDate).toLocaleDateString('he-IL') : (state.formData.orderDate || new Date().toLocaleDateString('he-IL'));
                const deliveryTimeToDisplay = state.isNewOrderMode ? state.formData.newDeliveryTime : (state.formData.orderTime || '×œ× ×¦×•×™×Ÿ');
                const customerAddressToDisplay = state.isNewOrderMode ? '×œ× ×¦×•×™×Ÿ' : state.formData.customerAddress;
                const siteAccessTypeToDisplay = state.isNewOrderMode ? state.formData.siteAccessType : '×œ× ×¦×•×™×Ÿ';

                const locationDisplay = state.formData.location && state.formData.location.lat ? 
                    `×ª×™×¢×•×“ ××™×§×•× × ×”×’ ×‘×–××Ÿ ×××ª: ×§×• ×¨×•×—×‘ ${state.formData.location.lat.toFixed(4)}, ×§×• ××•×¨×š ${state.formData.location.lon.toFixed(4)} ×‘×©×¢×” ${new Date(state.formData.location.timestamp).toLocaleTimeString('he-IL')} ×¢"×™ ${state.formData.driver}. (×œ×›×ª×•×‘×ª ×¨×—×•×‘ ××œ××” × ×“×¨×© ×©×™×¨×•×ª ××™×¤×•×™ ×—×™×¦×•× ×™)` : 
                    `×ª×™×¢×•×“ ××™×§×•× × ×”×’ ×‘×–××Ÿ ×××ª: ${state.formData.location}`;

                pdfTemplate.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #333; padding-bottom: 10px;">
                        <img src="${document.querySelector('header img').src}" style="width: 30mm; height: 30mm; object-fit: contain;">
                        <div style="text-align: left;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">×—. ×¡×‘×Ÿ - ×—×•××¨×™ ×‘× ×™×Ÿ 1994 ×‘×¢"×</h1>
                            <p style="margin: 2px 0;">×—.×¤: 512001678 | ×”×ª×œ××™×“ 6, ×”×•×“ ×”×©×¨×•×Ÿ</p>
                        </div>
                    </div>
                    <h2 style="text-align: center; font-size: 22px; font-weight: bold; margin: 15px 0; text-decoration: underline;">×ª×¢×•×“×ª ×¢×‘×•×“×” / ××©×œ×•×—</h2>
                    <p style="text-align: left; font-size: 12px;">××¡×¤×¨ ××¡××›×ª×: ${state.formData.serialNumber}</p>
                    <p style="text-align: left; font-size: 12px;">×ª××¨×™×š ×”×¤×§×”: ${new Date().toLocaleDateString('he-IL')}</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; border: 1px solid #ccc; padding: 10px; border-radius: 5px;">
                        <div><strong>×©× × ×”×’:</strong> ${state.formData.driver} (${state.formData.vehicle || '×œ× ×¦×•×™×Ÿ ×¨×›×‘'})</div>
                        <div><strong>××¡' ×”×–×× ×”:</strong> ${orderIdToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×©× ×œ×§×•×—:</strong> ${customerNameToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×›×ª×•×‘×ª:</strong> ${customerAddressToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×ª××¨×™×š ××¡×¤×§×”:</strong> ${deliveryDateToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×©×¢×ª ××¡×¤×§×”:</strong> ${deliveryTimeToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×’×™×©×” ×œ××ª×¨:</strong> ${siteAccessTypeToDisplay || '×œ× ×¦×•×™×Ÿ'}</div>
                    </div>
                    <h3 style="margin-top: 15px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">×ª×™×¢×•×“ ×–×× ×™×</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px 10px; font-size: 14px;">
                        <div><strong>×ª×—×™×œ×ª ×”××ª× ×”:</strong> ${state.formData.waitStartTime || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×¡×™×•× ×”××ª× ×”:</strong> ${state.formData.waitEndTime || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×ª×—×™×œ×ª ×× ×•×£:</strong> ${state.formData.craneStartTime || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div><strong>×¡×™×•× ×× ×•×£:</strong> ${state.formData.craneEndTime || '×œ× ×¦×•×™×Ÿ'}</div>
                    </div>
                    <h3 style="margin-top: 15px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px;">×¤×¨×˜×™ ×¢×‘×•×“×” ×•×”×—×–×¨×•×ª</h3>
                    <p><strong>×¡×•×’ ×¢×‘×•×“×ª ×× ×•×£:</strong> ${state.formData.craneWorkType || '×œ× ×¦×•×™×Ÿ'}</p>
                    ${state.formData.craneWorkType === '×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨' ? `<p><strong>×”×¢×‘×¨×” ×:</strong> ${state.formData.transferFrom || '×œ× ×¦×•×™×Ÿ'}<br><strong>××œ:</strong> ${state.formData.transferTo || '×œ× ×¦×•×™×Ÿ'}</p>` : ''}
                    ${state.formData.returns.filter(r=>r.item).length > 0 ? `<h4><strong>×”×—×–×¨×•×ª:</strong></h4><ul>${state.formData.returns.filter(r=>r.item).map(r => `<li>${r.item}: ${r.qty}</li>`).join('')}</ul>` : ''}
                    ${state.formData.notes ? `<h4 style="margin-top: 10px;"><strong>×”×¢×¨×•×ª × ×”×’:</strong></h4><p style="border: 1px solid #eee; padding: 5px;">${state.formData.notes}</p>` : ''}
                    <div style="position: absolute; bottom: 15mm; left: 15mm; right: 15mm; display:flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <h4 style="font-weight: bold;">××™×©×•×¨ ×§×‘×œ×ª ×©×™×¨×•×ª / ×¡×—×•×¨×”</h4>
                            <p>×× ×™ ×”×—"×, ${state.formData.receiverName || '×œ× ×¦×•×™×Ÿ'}, ×××©×¨ ×§×‘×œ×ª ×”×©×™×¨×•×ª/×”×¡×—×•×¨×”.</p>
                            <p>${locationDisplay}</p>
                        </div>
                        <div style="text-align: center;">
                            ${state.formData.signature ? `<img src="${state.formData.signature}" style="width: 50mm; height: 25mm; object-fit: contain; border-bottom: 1px solid #333;">` : `<p style="font-size: 12px; border-bottom: 1px solid #333; padding-bottom: 5px; width: 50mm; margin: 0 auto;">××™×Ÿ ×—×ª×™××”</p>`}
                            <p style="font-size: 12px;">×—×ª×™××ª ×”×œ×§×•×—</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(pdfTemplate);
                
                const pdfCanvas = await html2canvas(pdfTemplate, { scale: 2, useCORS: true });
                const pdfDataURL = pdfCanvas.toDataURL('image/png');
                
                // Add first page (form content)
                const imgProps = pdf.getImageProperties(pdfDataURL);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(pdfDataURL, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                // Add images to PDF
                if (state.formData.images.length > 0) {
                    pdf.addPage();
                    pdf.text('×ª××•× ×•×ª ××¦×•×¨×¤×•×ª', 15, 20);
                    let y = 30;
                    state.formData.images.forEach((imgSrc) => {
                        if (y > 250) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.addImage(imgSrc, 'JPEG', 15, y, 80, 60);
                        y += 70;
                    });
                }
                
                const finalPdfData = pdf.output('datauristring'); // Get PDF as data URI string

                // Prepare data for Apps Script
                const dataToSend = {
                    formData: state.formData,
                    pdfData: finalPdfData,
                    imageData: state.formData.images // Array of base64 image data
                };

                // Send data to Google Apps Script Web App
                const appsScriptWebAppUrl = 'https://script.google.com/macros/s/AKfycbxcM27A_uhxxlYFOo1tKUSYrfaptDb6f6ZAbqwOb93j3Ux5nkWgLMrPy548ps8Q1necJQ/exec'; // Replace with your deployed Apps Script URL
                console.log('Sending data to Apps Script URL:', appsScriptWebAppUrl); // Added for debugging
                try {
                    const response = await fetch(appsScriptWebAppUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(dataToSend),
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showAppMessage('×”×˜×•×¤×¡ × ×©×œ×— ×‘×”×¦×œ×—×” ×œ××¢×¨×›×ª!', 'success');
                        document.getElementById('confirmation-modal').classList.remove('hidden');
                        document.getElementById('confirmation-modal').querySelector('.modal-content').classList.add('show');
                    } else {
                        showAppMessage(`×©×’×™××” ×‘×©×œ×™×—×”: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showAppMessage(`×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ${error.message}`, 'error');
                }
                
                document.body.removeChild(pdfTemplate);
            }


            function setupEventListeners() {
                backBtn.addEventListener('click', () => handleNavigation('back'));
                nextBtn.addEventListener('click', () => handleNavigation('next'));
                submitBtn.addEventListener('click', handleSubmit);
                
                startNewOrderBtn.addEventListener('click', () => {
                    state.isNewOrderMode = true;
                    state.formData.orderId = null;
                    state.formData.customerName = null;
                    state.formData.customerAddress = null;
                    state.formData.items = [];
                    newOrderIdInput.value = '';
                    newCustomerNameInput.value = '';
                    newDeliveryDateInput.value = '';
                    newDeliveryTimeInput.value = '';
                    siteAccessSelect.value = '-- ×‘×—×¨ ×¡×•×’ ×’×™×©×” --';
                    orderDetailsContainer.classList.add('hidden');
                    updatePage();
                });

                backToExistingOrderBtn.addEventListener('click', () => {
                    state.isNewOrderMode = false;
                    state.formData.newOrderId = null;
                    state.formData.newCustomerName = null;
                    state.formData.newDeliveryDate = null;
                    state.formData.newDeliveryTime = null;
                    state.formData.siteAccessType = null;
                    updatePage();
                });


                driverSelect.addEventListener('change', (e) => {
                    const selectedDriver = MOCK_DATA.drivers.find(d => d.name === e.target.value);
                    if (selectedDriver) {
                        state.formData.driver = selectedDriver.name;
                        state.formData.vehicle = selectedDriver.vehicle;
                        populateOrders();
                        showAppMessage(`×©×œ×•× ${state.formData.driver}, ×‘×¨×•×š ×”×‘× ×œ××¢×¨×›×ª!`, 'info');
                    }
                });
                
                orderSelect.addEventListener('change', (e) => {
                    const selectedOrder = MOCK_DATA.orders.find(o => o.id === e.target.value);
                    if (selectedOrder) {
                        state.formData.orderId = selectedOrder.id;
                        state.formData.customerName = selectedOrder.customer;
                        state.formData.customerAddress = selectedOrder.address;
                        state.formData.items = selectedOrder.items;
                        
                        orderDetailsContainer.classList.remove('hidden');
                        document.getElementById('order-id-display').textContent = selectedOrder.id;
                        document.getElementById('order-date-display').textContent = new Date().toLocaleDateString('he-IL');
                        document.getElementById('customer-name-display').textContent = selectedOrder.customer;
                        document.getElementById('customer-address-display').textContent = selectedOrder.address;
                        
                        const tbody = document.getElementById('order-items-tbody');
                        tbody.innerHTML = '';
                        selectedOrder.items.forEach(item => {
                            tbody.innerHTML += `
                                <tr class="bg-white border-b">
                                    <td class="px-6 py-4">${item.sku}</td>
                                    <td class="px-6 py-4">${item.desc}</td>
                                    <td class="px-6 py-4">${item.qty}</td>
                                </tr>
                            `;
                        });
                        showAppMessage(`×”×–×× ×” ××¡×¤×¨ ${state.formData.orderId} × ×˜×¢× ×” ×‘×”×¦×œ×—×”.`, 'success');
                    }
                });
                
                document.getElementById('crane-work-type-group').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const value = e.target.dataset.value;
                        state.formData.craneWorkType = value;
                        
                        document.querySelectorAll('#crane-work-type-group button').forEach(btn => btn.classList.remove('btn-choice-active'));
                        e.target.classList.add('btn-choice-active');
                        
                        if (value === '×”×¢×‘×¨×” ×××ª×¨ ×œ××ª×¨') {
                            document.getElementById('transfer-modal').classList.remove('hidden');
                            document.getElementById('transfer-modal').querySelector('.modal-content').classList.add('show');
                        }
                    }
                });

                document.getElementById('add-return-item-btn').addEventListener('click', addReturnItem);
                
                document.getElementById('clear-signature-btn').addEventListener('click', () => signaturePad.clear());
                
                document.getElementById('open-camera-btn').addEventListener('click', () => document.getElementById('camera-input').click());
                
                document.getElementById('camera-input').addEventListener('change', (event) => {
                    if (event.target.files && event.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            state.formData.images.push(e.target.result);
                            const previewContainer = document.getElementById('image-previews');
                            const imgWrapper = document.createElement('div');
                            imgWrapper.className = 'relative';
                            imgWrapper.innerHTML = `<img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg shadow"><button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center font-bold">X</button>`;
                            previewContainer.appendChild(imgWrapper);
                            
                            imgWrapper.querySelector('button').onclick = () => {
                                state.formData.images = state.formData.images.filter(img => img !== e.target.result);
                                imgWrapper.remove();
                            };
                        };
                        reader.readAsDataURL(event.target.files[0]);
                    }
                });
                
                document.getElementById('confirm-transfer-btn').addEventListener('click', () => {
                    state.formData.transferFrom = document.getElementById('transfer-from').value;
                    state.formData.transferTo = document.getElementById('transfer-to').value;
                    document.getElementById('transfer-modal').classList.add('hidden');
                    document.getElementById('transfer-modal').querySelector('.modal-content').classList.remove('show');
                });
                document.getElementById('cancel-transfer-btn').addEventListener('click', () => {
                    document.getElementById('transfer-modal').classList.add('hidden');
                    document.getElementById('transfer-modal').querySelector('.modal-content').classList.remove('show');
                });
                 document.getElementById('close-confirmation-btn').addEventListener('click', () => {
                    document.getElementById('confirmation-modal').classList.add('hidden');
                    document.getElementById('confirmation-modal').querySelector('.modal-content').classList.remove('show');
                    window.location.reload();
                });

                document.getElementById('wait-start-time').addEventListener('focus', () => showAppMessage(`${state.formData.driver}, ×× × ×ª×¢×“ ×©×¢×•×ª ×‘××“×•×™×§.`, 'info'));
                document.getElementById('wait-end-time').addEventListener('focus', () => showAppMessage(`${state.formData.driver}, ×× × ×ª×¢×“ ×©×¢×•×ª ×‘××“×•×™×§.`, 'info'));
                document.getElementById('crane-start-time').addEventListener('focus', () => showAppMessage(`${state.formData.driver}, ×× × ×ª×¢×“ ×©×¢×•×ª ×‘××“×•×™×§.`, 'info'));
                document.getElementById('crane-end-time').addEventListener('focus', () => showAppMessage(`${state.formData.driver}, ×× × ×ª×¢×“ ×©×¢×•×ª ×‘××“×•×™×§.`, 'info'));
            }

            window.addEventListener('resize', () => {
                const canvas = document.getElementById('signature-pad');
                if (canvas && signaturePad) {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    signaturePad.clear();
                }
            });
            window.dispatchEvent(new Event('resize'));
            
            initialize();
        });
    </script>
</body>
</html>
